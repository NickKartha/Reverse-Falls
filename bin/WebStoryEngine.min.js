var Squiddle=function(e,t){"use strict";e=e||{log:function(){},dir:function(){}},t=t||{};var s,i;return s=function(t){if(t=t||{},!(this instanceof s))return new s(t);this.debug=t.debug||!1,this.interceptErrors=t.interceptErrors||!1,this.log=t.log||!1,this.logData=t.logData||!1,this.callbacks={"*":[]};var i,n=this;i=function(t){if(n.debug===!0){var s=t.error.name||"Error";e.log(s+" in listener; Event: "+t.info.event+"; Message: "+t.error.message)}},this.subscribe(i,"squiddle.error")},s.create=function(e){return e=e||{},new s(e)},s.prototype.subscribe=function(e,t){if("undefined"!=typeof t&&"string"!=typeof t&&"number"!=typeof t)throw new Error("Event names can only be strings or numbers!");if("function"!=typeof e)throw new Error("Only functions may be used as listeners!");t=t||"*",this.callbacks[t]=this.callbacks[t]||[],this.callbacks[t].push(e),this.trigger("squiddle.subscribe",{listener:e,event:t,bus:this})},s.prototype.unsubscribe=function(e,t){if("undefined"!=typeof t&&"string"!=typeof t&&"number"!=typeof t)throw new Error("Event names can only be strings or numbers!");t=t||"*";var s,i=this.callbacks[t]||[],n=i.length;for(s=0;n>s;++s)i[s]===e&&this.callbacks[t].splice(s,1);this.trigger("squiddle.unsubscribe",{listener:e,event:t,bus:this})},s.prototype.trigger=function(t,s,n){if("undefined"!=typeof t&&"string"!=typeof t&&"number"!=typeof t)throw new Error("Event names can only be strings or numbers!");t=t||"*",s=s||null,n="undefined"!=typeof n&&n===!1?!1:!0;var r,a,o,u,c,h,l=this;r=function(){var e,s,i,n,r,a,o="",u=[];for(s=t.split("."),e=0,i=s.length;i>e;++e)for(o=o+(e>0?".":"")+s[e],n=l.callbacks[o]||[],r=0,a=n.length;a>r;++r)u.push(n[r]);if("*"===t)return u;for(n=l.callbacks["*"]||[],r=0,a=n.length;a>r;++r)u.push(n[r]);return u}(),a=r.length,o={event:t,subscribers:a,getQueueLength:function(){return 0===a?0:a-(u+1)}},i=function(e){setTimeout(function(){throw e},0)},c=function(){for(l.log===!0&&e.log("Squiddle event triggered: "+t+"; Subscribers: "+a,l.logData===!0?"; Data: "+s:""),u=0;a>u;++u){h=r[u];try{h(s,o)}catch(n){e.log("Error is: "+n),l.trigger("squiddle.error",{error:n,info:o}),l.interceptErrors!==!0&&i(n)}}},n===!0?setTimeout(c,0):c()},s.inject=function(e,t){t=t||{};var i=new s(t);e.subscribe=function(e,t){t=t||"*",i.subscribe(e,t)},e.unsubscribe=function(e,t){t=t||"*",i.unsubscribe(e,t)},e.trigger=function(e,t,s){e=e||"*",t=t||null,s="undefined"!=typeof s&&s===!1?!1:!0,i.trigger(e,t,s)}},t.create=s,t.inject=s.inject,s}("undefined"==typeof console?!1:console,"undefined"==typeof exports?!1:exports),console=console||{log:function(){}},STEINBECK=STEINBECK||{};STEINBECK.Keys=function(e){if(e=e||{},!(this instanceof STEINBECK.Keys))return new STEINBECK.Keys(e);this.keys={},this.keys.BACKSPACE={kc:8},this.keys.TAB={kc:9},this.keys.ENTER={kc:13,which:13},this.keys.SHIFT={kc:16},this.keys.CTRL={kc:17},this.keys.ALT={kc:18},this.keys.PAUSE={kc:19},this.keys.CAPS_LOCK={kc:20},this.keys.ESCAPE={kc:27},this.keys.SPACE={kc:32},this.keys.PAGE_UP={kc:33},this.keys.PAGE_DOWN={kc:20},this.keys.END={kc:20},this.keys.HOME={kc:20},this.keys.LEFT_ARROW={kc:37},this.keys.UP_ARROW={kc:38},this.keys.RIGHT_ARROW={kc:39},this.keys.DOWN_ARROW={kc:40},this.keys.INSERT={kc:45},this.keys.DELETE={kc:46},this.keys.NUM_0={kc:48},this.keys.NUM_1={kc:49},this.keys.NUM_2={kc:50},this.keys.NUM_3={kc:51},this.keys.NUM_4={kc:52},this.keys.NUM_5={kc:53},this.keys.NUM_6={kc:54},this.keys.NUM_7={kc:55},this.keys.NUM_8={kc:56},this.keys.NUM_9={kc:57},this.keys.A={kc:65},this.keys.B={kc:66},this.keys.C={kc:67},this.keys.D={kc:68},this.keys.E={kc:69},this.keys.F={kc:70},this.keys.G={kc:71},this.keys.H={kc:72},this.keys.I={kc:73},this.keys.J={kc:74},this.keys.K={kc:75},this.keys.L={kc:76},this.keys.M={kc:77},this.keys.N={kc:78},this.keys.O={kc:79},this.keys.P={kc:80},this.keys.Q={kc:81},this.keys.R={kc:82},this.keys.S={kc:83},this.keys.T={kc:84},this.keys.U={kc:85},this.keys.V={kc:86},this.keys.W={kc:87},this.keys.X={kc:88},this.keys.Y={kc:89},this.keys.Z={kc:90},this.keys.LEFT_WIN={kc:91},this.keys.RIGHT_WIN={kc:92},this.keys.SELECT={kc:93},this.keys.NUMPAD_0={kc:96},this.keys.NUMPAD_1={kc:97},this.keys.NUMPAD_2={kc:98},this.keys.NUMPAD_3={kc:99},this.keys.NUMPAD_4={kc:100},this.keys.NUMPAD_5={kc:101},this.keys.NUMPAD_6={kc:102},this.keys.NUMPAD_7={kc:103},this.keys.NUMPAD_8={kc:104},this.keys.NUMPAD_9={kc:105},this.keys.MULTIPLY={kc:106},this.keys.ADD={kc:107},this.keys.SUBSTRACT={kc:109},this.keys.DECIMAL_POINT={kc:110},this.keys.DIVIDE={kc:111},this.keys.F1={kc:112},this.keys.F2={kc:113},this.keys.F3={kc:114},this.keys.F4={kc:115},this.keys.F5={kc:116},this.keys.F6={kc:117},this.keys.F7={kc:118},this.keys.F8={kc:119},this.keys.F9={kc:120},this.keys.F10={kc:121},this.keys.F11={kc:122},this.keys.F12={kc:123},this.keys.NUM_LOCK={kc:144},this.keys.SCROLL_LOCK={kc:145},this.keys.SEMI_COLON={kc:186},this.keys.EQUALS={kc:187},this.keys.COMMA={kc:188},this.keys.DASH={kc:189},this.keys.PERIOD={kc:190},this.keys.SLASH={kc:191},this.keys.GRAVE={kc:192},this.keys.OPEN_BRACKET={kc:219},this.keys.BACK_SLASH={kc:220},this.keys.CLOSE_BRACKET={kc:221},this.keys.SINGLE_QUOTE={kc:222},this.listeners=[];var t,s,i,n,r,a,o=e.log||!1,u=e.element||window,c=this;t=function(e){null!=e&&"undefined"!=typeof e&&(e.addEventListener?(e.addEventListener("keyup",i,!1),e.addEventListener("keydown",n,!1),e.addEventListener("keypress",r,!1),o===!0&&(e.addEventListener("keyup",a,!1),e.addEventListener("keydown",a,!1),e.addEventListener("keypress",a,!1))):e.attachEvent&&(e.attachEvent("onkeyup",i),e.attachEvent("onkeydown",n),e.attachEvent("onkeypress",r),o===!0&&(e.attachEvent("onkeyup",a),e.attachEvent("onkeydown",a),e.attachEvent("onkeypress",a))))},s=function(e,t){var s,i,n=c.listeners.length;for(i=0;n>i;++i)s=c.listeners[i],"undefined"!=typeof s&&s.type==t&&(s.key=s.key||{},kc=s.key.kc||null,which=s.key.which||null,(e.which==which||e.keyCode==kc)&&s.callback(e))},i=function(e){s(e,"up")},n=function(e){s(e,"down")},r=function(e){s(e,"press")},a=function(e){console.log(e)},t(u)},STEINBECK.Keys.prototype.addListener=function(e,t,s){if(s=s||"up","up"!==s&&"down"!==s&&"press"!==s)throw new Error("Event type not recognized.");this.listeners.push({key:e,callback:t,type:s})},STEINBECK.Keys.prototype.removeListener=function(e,t,s){s=s||null;for(var i,n=this.listeners.length,r=0;n>r;++r)i=this.listeners[r],(null===s||i.type==s)&&"undefined"!=typeof i&&i.key===e&&i.callback===t&&delete this.listeners[r]},STEINBECK.Keys.prototype.forAll=function(e,t){if(t=t||"up","up"!==t&&"down"!==t&&"press"!==t)throw new Error("Event type not recognized.");for(var s in this.keys)this.keys.hasOwnProperty(s)&&this.addListener(this.keys[s],e,t)},window.requestAnimationFrame=function(){"use strict";return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}();var MO5=function(){"use strict";var e=e||{log:function(){}},t={};return t.timers={},t.highestId=0,t.bus=new Squiddle,t.getUniqueId=function(){var e,s,i,n;return e=255*Math.random(),s=255*Math.random(),i=255*Math.random(),t.highestId+=1,n=t.highestId+parseInt(e*s*i,10)},t.fitToWindow=function(e,s,i){var n,r,a,o,u,c;n=t.getWindowDimensions(),a=n.width,o=n.height,u=a/s,c=o/i,r=u>c?c:u,e.setAttribute("style",e.getAttribute("style")+" -moz-transform: scale("+r+","+r+") rotate(0.01deg); -ms-transform: scale("+r+","+r+"); -o-transform: scale("+r+","+r+"); -webkit-transform: scale("+r+","+r+"); transform: scale("+r+","+r+");")},t.transform=function(s,i,n,r){if(r=r||{},"undefined"==typeof s||!s)throw new Error("MO5.transform expects parameter callback to be a function.");var a,o,u,c,h,l=(new Date).getTime(),d=i,g=0,m=n-i,p=r.log||!1,f=0,b=r.onFinish||function(){};return a="undefined"!=typeof r.duration?r.duration:1e3,o=Date.now||function(){return+new Date},u=r.easing||t.easing.sineEaseOut,c=function(){var r,y,v;return y=o(),f+=1,r=o(),g=r-l,g>a?(d=i+m,s(n),clearInterval(h),delete t.timers[h],void b()):(requestAnimationFrame(c),d=u(a,g)*m+i,s(d),v=o()-y,void(p===!0&&e.log("Current value: "+d+"; c: "+f+"; Exec time: "+v)))},h=t.getUniqueId(),requestAnimationFrame(c),t.timers[h]=!0,h},t.createTimer=function(e){var s;return e=e||0,e=0>e?0:e,s=setTimeout(function(){delete t.timers[s]},e),t.timers[s]=!0,s},t.getWindowDimensions=function(){var e=window,t="inner";return"innerWidth"in e||(t="client",e=document.documentElement||document.body),{width:e[t+"Width"],height:e[t+"Height"]}},t.Point=function(e,t){this.x=e,this.y=t},t.Point.prototype.getDistance=function(e){var t=this.x-e.x,s=this.y-e.y,i=Math.squrt(t*t+s*s);return i},t.easing={},t.easing.linear=function(e,t){return t/e},t.easing.sineEaseOut=function(e,t){var s=Math.PI/(2*e),i=Math.abs(Math.sin(t*s));return i},t.easing.sineEaseIn=function(e,t){var s=Math.PI/(2*e),i=Math.abs(-Math.cos(t*s)+1);return i},t.easing.sineEaseInOut=function(e,s){return 1>s/(e/2)?t.easing.sineEaseIn(e,s):t.easing.sineEaseOut(e,s)},t.easing.easeOutBounce=function(e,t){var s=0,i=1;return(t/=e)<1/2.75?7.5625*i*t*t+s:2/2.75>t?i*(7.5625*(t-=1.5/2.75)*t+.75)+s:2.5/2.75>t?i*(7.5625*(t-=2.25/2.75)*t+.9375)+s:i*(7.5625*(t-=2.625/2.75)*t+.984375)+s},t.easing.createEaseOutFunction=function(e){var t=function(t,s){return 1-Math.pow(1-s/t,e)};return t},t.easing.createEaseInFunction=function(e){var t=function(t,s){return Math.pow(s/t,e)};return t},t.easing.createEaseInOutFunction=function(e){var s,i,n;return i=t.easing.createEaseInFunction(e),n=t.easing.createEaseOutFunction(e),s=function(e,t){var s;return s=t>e/2?n(e,t):i(e,t)}},t.easing.easeOutQuad=t.easing.createEaseOutFunction(2),t.easing.easeOutCubic=t.easing.createEaseOutFunction(3),t.easing.easeOutQuart=t.easing.createEaseOutFunction(4),t.easing.easeOutQuint=t.easing.createEaseOutFunction(5),t.easing.easeInQuad=t.easing.createEaseInFunction(2),t.easing.easeInCubic=t.easing.createEaseInFunction(3),t.easing.easeInQuart=t.easing.createEaseInFunction(4),t.easing.easeInQuint=t.easing.createEaseInFunction(5),t.easing.easeInOutQuad=t.easing.createEaseInOutFunction(2),t.easing.easeInOutCubic=t.easing.createEaseInOutFunction(3),t.easing.easeInOutQuart=t.easing.createEaseInOutFunction(4),t.easing.easeInOutQuint=t.easing.createEaseInOutFunction(5),t.mixins={},t.mixins.display=function(){var e=this;this.canvas.addCallback(this.id,function(){e.draw()},this.layer||0,this)},t.mixins.hide=function(){this.canvas.removeCallback(this.id)},t.mixins.getCenter=function(){var e=this.x+this.width/2,s=this.y+this.height/2;return new t.Point(e,s)},t.mixins.change=function(e,t){this[e]=t,this.updated=!0},t.mixins.moveTo=function(e,s,i){i=i||{};var n,r,a=this;return n=t.transform(function(e){a.x=e},this.x,e,i),r=t.transform(function(e){a.y=e},this.y,s,i),[n,r]},t.mixins.move=function(e,t,s){var i,n;return s=s||{},i=this.x+e,n=this.y+t,this.moveTo(i,n,s)},t.mixins.fadeIn=function(e){e=e||{};var s=this;return t.transform(function(e){s.opacity=e},this.opacity,1,e)},t.mixins.fadeOut=function(e){e=e||{};var s=this;return t.transform(function(e){s.opacity=e},this.opacity,0,e)},t.Animation=function(e){return this instanceof t.Animation?(this.cbs=e.slice(),this.isRunning=!1,this.stopped=!0,this.paused=!1,this.timers={},void(this.index=0)):new t.Animation(e)},t.Animation.prototype.animate=function(e,s){s=s||function(){};var i,n,r,a,o=this,u=e.slice(),c=u[this.index];if("undefined"==typeof c||null===c)return this.index=0,s();if(this.index+=1,i=c(),"undefined"==typeof i)return void this.animate(u,s);for(n=i.length,r=0;n>r;++r)this.timers[i[r]]=t.timers[i[r]];a=function(){o.animate(u,s)},this.onTimersFinished(i,a)},t.Animation.prototype.onTimersFinished=function(e,s){var i,n,r=e.length,a=this;for(n=function(){a.onTimersFinished(e,s)},i=0;r>i;++i)if("undefined"!=typeof t.timers[e[i]]&&t.timers[e[i]]===!0)return void setTimeout(n,20);s()},t.Animation.prototype.run=function(){var e=this;this.isRunning!==!1&&setTimeout(function(){return this.stopped!==!0?this.paused===!0?e.run():void e.animate(e.cbs,function(){e.run()}):void 0},0)},t.Animation.prototype.start=function(){this.stopped=!1,this.isRunning=!0,this.run()},t.Animation.prototype.loop=function(e,t){var s=this;e=e||1,t=t||0,setTimeout(function(){t++,t>e||s.animate(s.cbs,function(){s.loop(e,t)})},20)},t.Animation.prototype.stop=function(e){var t,s=e||!1,i=this;if(this.stopped=!s,s!==!0)for(t in this.timers)this.timers.hasOwnProperty(t)&&(clearInterval(t),"undefined"!=typeof i.timers[t]&&delete i.timers[t]);this.isRunning=!1},t.canvas={},t.canvas.PrototypeObject=function(){},t.canvas.PrototypeObject.prototype.move=t.mixins.move,t.canvas.PrototypeObject.prototype.moveTo=t.mixins.moveTo,t.canvas.PrototypeObject.prototype.fadeIn=t.mixins.fadeIn,t.canvas.PrototypeObject.prototype.fadeOut=t.mixins.fadeOut,t.canvas.PrototypeObject.prototype.display=t.mixins.display,t.canvas.PrototypeObject.prototype.hide=t.mixins.hide,t.canvas.PrototypeObject.prototype.getCenter=t.mixins.getCenter,t.canvas.PrototypeObject.prototype.change=t.mixins.change,t.canvas.Canvas=function(e){e=e||{},this.id=t.getUniqueId();var s=this,i=e.id||null,n=!1;null===i?(this.cv=document.createElement("canvas"),this.cv.setAttribute("id","MO5Canvas"+this.id)):this.cv=document.getElementById(i),this.ct=this.cv.getContext("2d"),this.fps=e.fps||30,this.tbf=1/this.fps,this.time=0,this.sine=0,this.width=e.width||800,this.height=e.height||450,this.functions=[],this.functionsByKey={},this.functionsByPriority=[],this.scale=e.scale||!1,this.scaleX=e.scaleX||1,this.scaleY=e.scaleY||1,this.frozen=!1,this.temp=document.createElement("canvas"),this.stopped=!0,this.bus=e.bus||t.bus,this.cv.width=this.width,this.cv.height=this.height,this.temp.width=this.width,this.temp.height=this.height,document.body.appendChild(this.cv),this.draw=function(){s.stopped===!1&&requestAnimationFrame(s.draw);var e=s.tbf;s.time+=e;var t,i,r,a=s.time,o=s.functions,u=s.cv,c=s.ct;if(s.frozen===!0&&n===!0)return void c.drawImage(s.temp,0,0);for(s.frozen===!1&&n===!0&&(n=!1),s.sine=(Math.sin(a)+1)/2,t={context:c,canvas:u,fps:s.fps,tbf:e,time:a,sine:s.sine},c.clearRect(0,0,u.width,u.height),r=0,i=o.length;i>r;++r)o[r].callback(t);s.frozen===!0&&(s.temp.clearRect(0,0,s.width,s.height),s.temp.drawImage(u,0,0),n=!0)}},t.canvas.Canvas.prototype.addCallback=function(e,t,s){var i=this.functionsByPriority,n={key:e,callback:t,priority:s||0};("undefined"==typeof i[s]||null===i[s])&&(this.functionsByPriority[s]=[]),this.functionsByPriority[s].push(n),this.functionsByKey[e]=n,this.rebuildFunctionQueue()},t.canvas.Canvas.prototype.rebuildFunctionQueue=function(){var e,t,s,i,n;for(this.functions=[],e=this.functionsByPriority.length,s=0;e>s;++s)if("undefined"!=typeof this.functionsByPriority[s])for(t=this.functionsByPriority[s],n=t.length,i=0;n>i;++i)this.functions.push(t[i])},t.canvas.Canvas.prototype.removeCallback=function(e){if("undefined"!=typeof this.functionsByKey[e]){var t,s=this.functionsByKey[e],i=s.priority,n=this.functionsByPriority[i],r=n.length;for(t=0;r>t;++t)n[t].key===e&&this.functionsByPriority[i].splice(t,1);this.rebuildFunctionQueue(),delete this.functionsByKey[e]}},t.canvas.Canvas.prototype.start=function(){this.stopped=!1,this.draw()},t.canvas.Canvas.prototype.stop=function(){this.stopped=!0},t.canvas.Canvas.prototype.fitToWindow=function(e){var s=t.getWindowDimensions(),i=this.cv,n=s.width,r=s.height,a=this.width/this.height,o=n/a,u=r*a,c=n/r;e=e||!1,e===!0&&n>=this.width&&r>=this.height||(c>a?o=r:u=n,i.setAttribute("style"," width: "+u+"px; height: "+o+"px; margin: auto; position: absolute; left: "+(n-u)/2+"px; top: "+(r-o)/2+"px;"))},t.canvas.Canvas.prototype.center=function(){var e=t.getWindowDimensions(),s=this.cv,i=e.width,n=e.height,r=this.height,a=this.width;s.setAttribute("style","position: absolute; left: "+(i-a)/2+"px; top: "+(n-r)/2+"px;")},t.canvas.ImagePack=function(e,s){return s=s||{},this instanceof t.canvas.ImagePack?(this.images={},this.current=null,this.x=s.x||0,this.y=s.y||0,this.id=t.getUniqueId(),this.canvas=e,this.layer=s.layer||0,this.alpha=s.alpha||1,this.rotation=s.rotation||0,this.pivotX=s.pivotX||this.x,this.pivotY=s.pivotY||this.y,this.shadowX=s.shadowX||5,this.shadowY=s.shadowY||5,this.shadowBlur=s.shadowBlur||5,this.shadowColor=s.shadowColor||"rgba(0, 0, 0, 0.5)",this.hasShadow=s.hasShadow||!1,void(this.updated=!0)):new t.canvas.ImagePack(e,s)},t.canvas.ImagePack.prototype=new t.canvas.PrototypeObject,t.canvas.ImagePack.prototype.draw=function(){var e=this,t=e.canvas.ct,s=e.x,i=e.y,n=e.rotation,r=e.pivotX,a=e.pivotY;if(null===e.current)throw new Error("You need to use set() before this method!");t.save(),t.globalAlpha=e.alpha,n>0&&(t.translate(r,a),t.rotate(Math.PI*n/180),t.translate(-r,-a)),e.hasShadow===!0&&(t.shadowOffsetX=e.shadowX,t.shadowOffsetY=e.shadowY,t.shadowBlur=e.shadowBlur,t.shadowColor=e.shadowColor),t.drawImage(e.current,.5+s|0,.5+i|0),t.restore()},t.canvas.ImagePack.prototype.addImage=function(e,t){var s=new Image;s.src=t,this.images[e]=s},t.canvas.ImagePack.prototype.removeImage=function(e){delete this.images[e]},t.canvas.ImagePack.prototype.set=function(e){if("undefined"==typeof this.images[e])throw new Error("This ImagePack doesn't have such an image.");this.current=this.images[e],this.width=this.current.width,this.height=this.current.height,this.pivotX=this.x+this.width/2,this.pivotY=this.y+this.height/2},t.canvas.ImagePack.prototype.animate=function(s){s=s||{};var i,n,r,a,o=s.names||null,u=[],c=s.duration||1e3,h=this,l=[];if(null===o)i=this.images;else for(r=0,n=o.length;r>n;++r){if("undefined"==typeof this.images[o[r]])throw new Error("No such image in this ImagePack.");i[o[r]]=this.images[o[r]]}for(a in i)i.hasOwnProperty(a)&&l.push(i[a]);return u.push(function(){var s=t.transform(function(t){return t=.5+t|0,"undefined"==typeof l[t]||null===l[t]?void e.log("No such image: "+t):void(h.current=l[t])},0,l.length-1,{duration:c,easing:t.easing.linear});return[s]}),new t.Animation(u)},t.canvas.TextBox=function(e,s){return s=s||{},this instanceof t.canvas.TextBox?(this.lastText="",this.lines=[],this.id=t.getUniqueId(),this.canvas=e,this.width=e.cv.width,this.height=e.cv.height,this.layer=s.layer||0,this.alpha=s.alpha||1,this.x=s.x||0,this.y=s.y||0,this.rotation=s.rotation||0,this.pivotX=s.pivotX||this.x+this.width/2,this.pivotY=s.pivotY||this.y+this.height/2,this.text=s.text||"",this.lineHeight=18,this.color="#fff",this.font=s.font||"bold 15px Arial, Helvetica, sans-serif",this.align=s.align||"left",this.shadowX=s.shadowX||2,this.shadowY=s.shadowY||2,this.shadowBlur=s.shadowBlur||2,this.shadowColor=s.shadowColor||"rgba(0, 0, 0, 0.5)",this.hasShadow=s.hasShadow||!1,void(this.updated=!0)):new t.canvas.TextBox(e,s)},t.canvas.TextBox.prototype=new t.canvas.PrototypeObject,t.canvas.TextBox.prototype.draw=function(){var e,t,s=this,i=s.canvas.ct,n=s.text.split(" "),r="",a="",o=n.length;if(i.save(),i.globalAlpha=s.alpha,s.rotation>0&&(i.translate(s.pivotX,s.pivotY),i.rotate(Math.PI*s.rotation/180),i.translate(-s.pivotX,-s.pivotY)),s.hasShadow===!0&&(i.shadowOffsetX=s.shadowX,i.shadowOffsetY=s.shadowY,i.shadowBlur=s.shadowBlur,i.shadowColor=s.shadowColor),i.fillStyle=s.color,i.font=s.font,i.textAlign=s.align,this.text!==s.lastText)for(s.lines=[],e=0;o>e;++e)r=n[e],i.measureText(a+" "+r).width>s.width&&(s.lines.push(a),a=""),a=a+" "+r,e===o-1&&s.lines.push(a);for(t=s.lines.length,e=0;t>e;++e)i.fillText(s.lines[e],.5+s.x|0,.5+(s.y+s.lineHeight*e)|0);s.lastText=s.text,s.canvas.ct.restore()},t.canvas.Rectangle=function(e,s){return s=s||{},this instanceof t.canvas.Rectangle?(this.id=t.getUniqueId(),this.canvas=e,this.width=s.width||e.cv.width,this.height=s.height||e.cv.height,this.layer=s.layer||0,this.alpha=s.alpha||1,this.x=s.x||0,this.y=s.y||0,this.rotation=s.rotation||0,this.pivotX=s.pivotX||this.x+this.width/2,this.pivotY=s.pivotY||this.y+this.height/2,this.color=s.color||"#fff",this.borderColor=s.borderColor||"#000",this.borderWidth=s.borderWidth||0,this.shadowX=s.shadowX||5,this.shadowY=s.shadowY||5,this.shadowBlur=s.shadowBlur||5,this.shadowColor=s.shadowColor||"rgba(0, 0, 0, 0.5)",void(this.hasShadow=s.hasShadow||!1)):new t.canvas.Rectangle(e,s)},t.canvas.Rectangle.prototype=new t.canvas.PrototypeObject,t.canvas.Rectangle.prototype.draw=function(){var e=this,t=e.canvas.ct,s=e.x,i=e.y,n=e.width,r=e.height,a=e.rotation,o=e.pivotX,u=e.pivotY;t.save(),t.globalAlpha=e.alpha,a>0&&(t.translate(o,u),t.rotate(Math.PI*a/180),t.translate(-o,-u)),e.hasShadow===!0&&(t.shadowOffsetX=e.shadowX,t.shadowOffsetY=e.shadowY,t.shadowBlur=e.shadowBlur,t.shadowColor=e.shadowColor),t.fillStyle=e.color,t.fillRect(s,i,n,r),e.borderWidth>0&&(t.strokeStyle=e.borderColor,t.lineWidth=e.borderWidth,t.strokeRect(s,i,n,r)),t.restore()},t.canvas.Rain=function(e,s){if(s=s||{},!(this instanceof t.canvas.Rain))return new t.canvas.Rain(e,s);var i=this;this.id=t.getUniqueId(),this.canvas=e,this.width=s.width||2*e.cv.width,this.height=s.height||2*e.cv.height,this.layer=s.layer||0,this.alpha=s.alpha||1,this.rotation=s.rotation||0,this.pivotX=s.pivotX||this.canvas.cv.width/2,this.pivotY=s.pivotY||this.canvas.cv.height/2,this.color=s.color||"#fff",this.drops=s.drops||100,this.data=null,this.speed=s.speed||20,this.x=s.x||(this.width-e.cv.width)/2,this.y=s.y||(this.height-e.cv.height)/2,this.lastDrawTime=0,this.canvas.bus.subscribe(function(){i.hide()},"mo5.canvas.rain.hideAll"),this.canvas.bus.subscribe(function(){i.display()},"mo5.canvas.rain.displayAll")},t.canvas.Rain.prototype=new t.canvas.PrototypeObject,t.canvas.Rain.prototype.draw=function(){var e,t,s,i,n,r=this,a=r.canvas.ct,o=r.drops,u=r.data,c=r.width,h=r.height;if(a.save(),a.globalAlpha=r.alpha,r.rotation>0&&(a.translate(r.pivotX,r.pivotY),a.rotate(Math.PI*r.rotation/180),a.translate(-r.pivotX,-r.pivotY)),null===u)for(u=[],e=0;o>e;++e)t=Math.random()*c-(r.width-r.canvas.cv.width)/2,s=Math.random()*h-(r.height-r.canvas.cv.height)/2,i=40*Math.random()+5,u.push({x:t,fy:s,ly:i});for(a.strokeStyle=r.color,a.lineWidth=1,a.beginPath(),e=0;o>e;++e)n=u[e],n.fy+=r.speed,n.fy>r.canvas.cv.height+n.ly&&(n.fy=0-(r.height-r.canvas.cv.height)/2-n.ly,n.x=Math.random()*c-(r.width-r.canvas.cv.width)/2),a.moveTo(n.x,n.fy),a.lineTo(n.x,n.fy+n.ly),a.moveTo(n.x-1,n.fy+2*(n.ly/3)),a.lineTo(n.x-1,n.fy+n.ly),u[e]=n;a.stroke(),a.closePath(),a.restore(),r.data=u},t.canvas.Rain.prototype.display=t.mixins.display,t.canvas.Rain.prototype.hide=t.mixins.hide,t.canvas.Rain.prototype.getCenter=t.mixins.getCenter,t.canvas.Rain.prototype.fadeIn=t.mixins.fadeIn,t.canvas.Rain.prototype.fadeOut=t.mixins.fadeOut,t.canvas.PixelManipulator=function(e,s){if(s=s||{},!(this instanceof t.canvas.PixelManipulator))return new t.canvas.PixelManipulator(e,s);var i=this;this.id=t.getUniqueId(),this.canvas=e,this.width=s.width||e.cv.width,this.height=s.height||e.cv.height,this.layer=s.layer||0,this.alpha=s.alpha||1,this.rotation=s.rotation||0,this.pivotX=s.pivotX||this.canvas.cv.width/2,this.pivotY=s.pivotY||this.canvas.cv.height/2,this.x=s.x||0,this.y=s.y||0,this.data=this.canvas.ct.createImageData(this.width,this.height),this.lastWidth=this.width,this.lastHeight=this.height,this.isChanged=!0,this.img=new Image,this.draw=function(){var e=i.canvas.ct,t=i.data,s=document.createElement("canvas"),n=s.getContext("2d");return e.save(),e.globalAlpha=i.alpha,i.rotation>0&&(e.translate(i.pivotX,i.pivotY),e.rotate(Math.PI*i.rotation/180),e.translate(-i.pivotX,-i.pivotY)),this.isChanged===!1?(e.drawImage(i.img,i.x,i.y),void e.restore()):(this.isChanged=!1,(i.lastWidth!==i.width||i.lastHeight!==i.height)&&(t=e.createImageData(i.width,i.height)),s.width=i.width,s.height=i.height,n.putImageData(t,i.x,i.y),i.img.src=s.toDataURL(),e.drawImage(i.img,i.x,i.y),e.restore(),void(i.data=t))}},t.canvas.PixelManipulator.prototype.setPixel=function(e,t,s,i,n,r){var a=4*(e+t*this.width),o=this.data.data;o[a]=s,o[a+1]=i,o[a+2]=n,o[a+3]=r,this.isChanged=!0},t.canvas.PixelManipulator.prototype.display=t.mixins.display,t.canvas.PixelManipulator.prototype.hide=t.mixins.hide,t.canvas.PixelManipulator.prototype.getCenter=t.mixins.getCenter,t.canvas.PixelManipulator.prototype.moveTo=t.mixins.moveTo,t.canvas.PixelManipulator.prototype.move=t.mixins.move,t.canvas.PixelManipulator.prototype.fadeIn=t.mixins.fadeIn,t.canvas.PixelManipulator.prototype.fadeOut=t.mixins.fadeOut,t.dom={},t.dom.effects={},t.dom.effects.typewriter=function(e,t){function s(e){var t,i,n=e.childNodes;if(e.nodeType===a)for(e.style.display="none",t=0,i=n.length;i>t;t+=1)s(n[t])}function i(e,t){e.nodeType===a?!function(){for(var s=[];e.hasChildNodes();)s.push(e.removeChild(e.firstChild));e.style.display="",function n(){s.length>0?(i(s[0],n),e.appendChild(s.shift())):t&&setTimeout(t,0)}()}():e.nodeType===o&&!function(){function s(){e.data+=a[i],i+=1,r>i?setTimeout(s,1e3/n):t&&setTimeout(t,0)}var i,r,a=e.data.replace(/ +/g," ");e.data="",i=0,r=a.length,s()}()}var n,r,a=1,o=3;t=t||{},n=t.speed||50,r=t.onFinish||null,s(e),i(e,r)},t.dom.PrototypeObject=function(){},t.dom.PrototypeObject.prototype.fadeIn=function(e){e=e||{};var s=this.node;return t.transform(function(e){s.style.opacity=e},0,1,e)},t.dom.PrototypeObject.prototype.fadeOut=function(e){e=e||{};var s=this.node;return t.transform(function(e){s.style.opacity=e},1,0,e)},t.dom.PrototypeObject.prototype.moveTo=function(e,s,i){i=i||{};var n,r,a=this.node,o=a.offsetLeft,u=a.offsetTop;return n=t.transform(function(e){a.style.left=e+"px"},o,e,i),r=t.transform(function(e){a.style.top=e+"px"},u,s,i),[n,r]},t.dom.PrototypeObject.prototype.move=function(e,t,s){s=s||{};var i=this.node,n=i.offsetLeft+e,r=i.offsetTop+t;return this.moveTo(n,r,s)},t.dom.PrototypeObject.prototype.display=function(){var e;try{e=this.parent||document.getElementsByTagName("body")[0],e.appendChild(this.node)}catch(t){}},t.dom.PrototypeObject.prototype.hide=function(){var e;try{e=this.parent||document.getElementsByTagName("body")[0],e.removeChild(this.node)}catch(t){}},t.dom.Node=function(e){return e=e||{},this instanceof t.dom.Node?(this.parent=e.parent||document.getElementsByTagName("body")[0],this.nodeType=e.nodeType||"div",this.node=e.node||document.createElement(this.nodeType),this.bus=e.bus||t.bus,void this.bus.trigger("mo5.dom.node.create",this)):new t.dom.Node(e)},t.dom.Node.prototype=new t.dom.PrototypeObject,t.dom.Node.prototype.constructor=t.dom.Node,t.dom.ImagePack=function(e){return e=e||{},this instanceof t.dom.ImagePack?(this.parent=e.parent||document.getElementsByTagName("body")[0],this.nodeType=e.nodeType||"div",this.node=e.node||document.createElement(this.nodeType),this.bus=e.bus||t.bus,void this.bus.trigger("mo5.dom.imagepack.create",this)):new t.dom.ImagePack(e)},t.dom.ImagePack.prototype=new t.dom.PrototypeObject,t}(),WSE=function(e,t,s){"use strict";var i={},n="0.4.0";return i.fx=t,i.Keys=s.Keys,e.inject(i),i.ajax={},i.datasources={},i.assets={},i.assets.mixins={displayable:{}},i.getVersion=function(){return n},console.log("WebStory Engine version "+i.getVersion()+" starting up..."),i.ajax.get=function(e,t){e=e+"?random="+Math.random();var s=new XMLHttpRequest;s.onreadystatechange=function(){if(4===s.readyState&&200===s.status&&t(s),4===s.readyState&&200!==s.status)throw new Error("WSE: Cannot load XML file.")},s.overrideMimeType&&s.overrideMimeType("text/xml"),s.open("GET",e,!0),s.send()},i.functions={savegames:function(e){e.toggleSavegameMenu()},stageclick_disable:function(e){e.game.unsubscribeListeners()},stageclick_enable:function(e){e.game.subscribeListeners()}},i}("undefined"==typeof Squiddle?!1:Squiddle,"undefined"==typeof MO5?!1:MO5,"undefined"==typeof STEINBECK?!1:STEINBECK);!function(e){"use strict";e.tools=e.tools||{},e.tools.attachEventListener=function(e,t,s){null!==e&&"undefined"!=typeof e&&(e.addEventListener?e.addEventListener(t,s,!1):e.attachEvent&&e.attachEvent("on"+t,s))},e.tools.applyAssetUnits=function(e,t){var s,i;s=t.getAttribute("x")||"",i=t.getAttribute("y")||"",e.xUnit=s.replace(/^.*(px|%)$/,"$1"),e.xUnit=e.xUnit||"px",e.yUnit=i.replace(/^.*(px|%)$/,"$1"),e.yUnit=e.yUnit||"px","px"!==e.xUnit&&"%"!==e.xUnit&&(e.xUnit="px"),"px"!==e.yUnit&&"%"!==e.yUnit&&(e.yUnit="px")},e.tools.removeEventListener=function(e,t,s){"undefined"!=typeof e&&null!==e&&e.removeEventListener(t,s,!1)},e.tools.replaceVariables=function(e,t){var s,i;return null===e?e:("string"!=typeof e&&(t.bus.trigger("wse.interpreter.error",{message:"Argument supplied to the replaceVariables function must be a string."}),e=""),s=function(){var e=arguments[1];return t.globalVars.has(e)?""+t.globalVars.get(e):""},i=function(){var e=arguments[1];return e in t.runVars?""+t.runVars[e]:""},e=e.replace(/\{\$\$([a-zA-Z0-9_]+)\}/g,s),e=e.replace(/\{\$([a-zA-Z0-9_]+)\}/g,i))},e.tools.getSerializedNodes=function(e){var t,s,i=new XMLSerializer,n=e.childNodes,r="";for(t=0,s=n.length;s>t;t+=1)r+=i.serializeToString(n[t]);return r},e.tools.getParsedAttribute=function(t,s,i,n){var r;return arguments.length<3&&(n=""),r=t.getAttribute(s)||""+n,e.tools.replaceVariables(r,i)},e.tools.textToHtml=function(e,t){return t=t||!1,String.prototype.trim?e=e.trim():(e=e.replace(/^\n/,""),e=e.replace(/\n$/,"")),e=t===!0?e.replace(/\n/g,"<br />"):e,e=e.replace(/\{/g,"<"),e=e.replace(/\}/g,">")},e.tools.getUniqueId=function(){var e=0;return function(){return e+=1}}(),e.tools.firstLetterUppercase=function(e){return e.length<1?"":""+e.charAt(0).toUpperCase()+e.replace(/^.{1}/,"")},e.tools.mixin=function(e,t){var s;for(s in e)e.hasOwnProperty(s)&&(t[s]=e[s])},e.tools.extractUnit=function(e){return"string"!=typeof e?"":e.replace(/^(-){0,1}[0-9]*/,"")},e.tools.calculateValueWithAnchor=function(t,s,i){var n=0,r="px";return null===s?t:(r=e.tools.extractUnit(s),s=parseInt(s,10),n="%"===r?t-i/100*s:t-s)}}(WSE),function(e){"use strict";e.datasources={},e.datasources.LocalStorage=function(){},e.datasources.LocalStorage.prototype.set=function(e,t){localStorage.setItem(e,t)},e.datasources.LocalStorage.prototype.get=function(e){return localStorage.getItem(e)},e.datasources.LocalStorage.prototype.remove=function(e){return localStorage.removeItem(e)}}(WSE),function(e){"use strict";e.Trigger=function(t,s){var i,n=this;if(this.name=t.getAttribute("name")||null,this.event=t.getAttribute("event")||null,this.special=t.getAttribute("special")||null,this.fnName=t.getAttribute("function")||null,this.scene=t.getAttribute("scene")||null,this.interpreter=s,this.isSubscribed=!1,null===this.name)return void s.bus.trigger("wse.interpreter.warning",{element:t,message:"No 'name' attribute specified on 'trigger' element."});if(null===this.event)return void s.bus.trigger("wse.interpreter.warning",{element:t,message:"No 'event' attribute specified on 'trigger' element '"+this.name+"'."});if(null===this.special&&null===this.fnName&&null===this.scene)return void s.bus.trigger("wse.interpreter.warning",{element:t,message:"No suitable action or function found for trigger element '"+this.name+"'."});if(this.scene&&(i=function(){console.log('Triggering event "'+n.event+'"...'),e.commands.sub(t,s),s.index=0,s.currentElement=0,s.next()}),this.isKeyEvent=!1,this.key=null,null!==this.special&&"next"!==this.special)return void s.bus.trigger("wse.interpreter.warning",{element:t,message:"Unknown special specified on trigger element '"+this.name+"'."});if("next"===this.special&&(i=function(){"pause"===n.interpreter.state||n.interpreter.waitCounter>0||n.interpreter.next()}),null!==this.fnName){if("function"!=typeof e.functions[this.fnName])return void s.bus.trigger("wse.interpreter.warning",{element:t,message:"Unknown function specified on trigger element '"+this.name+"'."});i=function(){e.functions[n.fnName](n.interpreter,t)}}switch(this.event){case"keyup":case"keydown":case"keypress":return this.isKeyEvent=!0,this.key=t.getAttribute("key")||null,null===this.key?void s.bus.trigger("wse.interpreter.warning",{element:t,message:"No 'key' attribute specified on trigger element '"+this.name+"'."}):"undefined"==typeof s.game.keys.keys[this.key]||null===s.game.keys.keys[this.key]?void s.bus.trigger("wse.interpreter.warning",{element:t,message:"Unknown key '"+this.key+"' specified on trigger element '"+this.name+"'."}):void(this.fn=function(e){e.keys[n.key].kc===e.event.keyCode&&(s.keysDisabled>0||i())
});default:this.fn=i}},e.Trigger.prototype.activate=function(){this.isSubscribed!==!0&&(this.interpreter.bus.subscribe(this.fn,this.event),this.isSubscribed=!0)},e.Trigger.prototype.deactivate=function(){this.isSubscribed!==!1&&(this.interpreter.bus.unsubscribe(this.fn,this.event),this.isSubscribed=!1)}}(WSE),function(e){"use strict";e.Game=function(t){var s;e.trigger("wse.game.constructor",{args:t,game:this}),t=t||{},this.bus=new Squiddle,this.url=t.url||"game.xml",this.ws=null,this.debug=t.debug===!0?!0:!1,s=t.host||!1,this.host=s,s?(this.ws=function(e){var t,i;return i=new DOMParser,t=s.get(e),i.parseFromString(t,"application/xml")}(this.url),this.init()):this.load(this.url),this.interpreter=new e.Interpreter(this),this.keys=new e.Keys,this.listenersSubscribed=!1,this.bus.subscribe(function(e){console.log("Message: "+e)},"wse.interpreter.message"),this.bus.subscribe(function(e){console.log("Error: "+e.message)},"wse.interpreter.error"),this.bus.subscribe(function(e){console.log("Warning: "+e.message,e.element)},"wse.interpreter.warning")},e.Game.prototype.load=function(){var t,s;s=this,t=function(e){s.ws=e.responseXML,s.init()},e.ajax.get(this.url,t)},e.Game.prototype.init=function(){var t,s,i,n,r,a,o,u,c,h;u=this,t=this.ws;try{i=t.getElementsByTagName("stage")}catch(l){console.log(l)}if(r="800px",a="480px",o="Stage",i.length<1)throw new Error("No stage definition found!");n=i[0],r=n.getAttribute("width")||r,a=n.getAttribute("height")||a,o=n.getAttribute("id")||o,"yes"===n.getAttribute("create")?(s=document.createElement("div"),s.setAttribute("id",o),document.body.appendChild(s)):s=document.getElementById(o),s.setAttribute("class","WSEStage"),s.style.width=r,s.style.height=a,c=function(){var t=e.fx.getWindowDimensions();s.style.left=t.width/2-parseInt(r,10)/2+"px",s.style.top=t.height/2-parseInt(a,10)/2+"px"},"yes"===n.getAttribute("center")&&(e.tools.attachEventListener(window,"resize",c),c()),h=function(){console.log("Resizing..."),e.fx.fitToWindow(s,parseInt(r,10),parseInt(a,10))},"yes"===n.getAttribute("resize")&&(e.tools.attachEventListener(window,"resize",h),h()),this.stage=s,this.applySettings(),this.host&&(this.host.window.width=parseInt(r,10),this.host.window.height=parseInt(a,10),function(t){var i="true"===t.getSetting("host.stage.resize")?!0:!1;i&&window.addEventListener("resize",function(){console.log("Resizing..."),e.fx.fitToWindow(s,parseInt(r,10),parseInt(a,10))})}(this))},e.Game.prototype.getSetting=function(e){var t,s,i,n,r,a;for(s=this.ws.getElementsByTagName("setting"),i=0,n=s.length;n>i;i+=1)if(r=s[i],a=r.getAttribute("name")||null,null!==a&&a===e)return t=r.getAttribute("value")||null;return null},e.Game.prototype.applySettings=function(){this.webInspectorEnabled="true"===this.getSetting("host.inspector.enable")?!0:!1,this.host&&this.webInspectorEnabled===!0&&this.host.inspector.show()},e.Game.prototype.start=function(){var t,s,i;return i=this,null===this.ws?setTimeout(function(){i.start()}):(t=function(){"pause"===i.interpreter.state||i.interpreter.waitCounter>0||(console.log("Next triggered by user..."),i.interpreter.next(!0))},s=function(e){return i.bus.trigger("contextmenu",{}),e&&"function"==typeof e.preventDefault&&e.preventDefault(),!1},this.subscribeListeners=function(){e.tools.attachEventListener(this.stage,"contextmenu",s),e.tools.attachEventListener(this.stage,"click",t),this.listenersSubscribed=!0},this.unsubscribeListeners=function(){e.tools.removeEventListener(this.stage,"contextmenu",s),e.tools.removeEventListener(this.stage,"click",t),this.listenersSubscribed=!1},void this.interpreter.start())}}(WSE),function(e){"use strict";e.Interpreter=function(t){var s,i;return this instanceof e.Interpreter?(e.trigger("wse.interpreter.constructor",{game:t,interpreter:this}),this.game=t,this.assets={},this.index=0,this.visitedScenes=[],this.log=[],this.waitForTimer=!1,this.assetsLoading=0,this.assetsLoadingMax=0,this.assetsLoaded=0,this.startTime=0,this.runVars={},this.callStack=[],this.keysDisabled=0,this.state="listen",this.waitCounter=0,this.debug=t.debug===!0?!0:!1,s=new e.datasources.LocalStorage,this.datasource=s,i="wse_globals_"+location.pathname+"_"+this.game.url+"_",this.globalVars={set:function(e,t){s.set(i+e,t)},get:function(e){return s.get(i+e)},has:function(e){return null===s.get(i+e)?!1:!0}},void(this.debug===!0&&(this.game.bus.debug=!0))):new e.Interpreter(t)},e.Interpreter.prototype.buildLoadingScreen=function(){var e,t,s;t=this,e=document.createElement("div"),e.setAttribute("id","WSELoadingScreen"),e.style.zIndex=1e4,e.style.width="100%",e.style.height="100%",e.innerHTML='<div class="container"><div class="heading"><span id="WSELoadingScreenPercentage"></span>Loading assets...</div><div class="progressBar"><div class="progress" id="WSELoadingScreenProgress" style="width: 100%;"></div></div></div>',this.game.stage.appendChild(e),s=function(){var e,s,i;try{e=document.getElementById("WSELoadingScreenProgress"),s=document.getElementById("WSELoadingScreenPercentage"),i=parseInt(t.assetsLoaded/t.assetsLoadingMax*100,10),t.assetsLoadingMax<1&&(i=0),e.style.width=i+"%",s.innerHTML=""+t.assetsLoaded+"/"+t.assetsLoadingMax+" ("+i+"%)"}catch(n){}},this.bus.subscribe(s,"wse.assets.loading.increase"),this.bus.subscribe(s,"wse.assets.loading.decrease"),this.loadScreen=e},e.Interpreter.prototype.start=function(){var t,s,i,n;this.story=this.game.ws,this.stage=this.game.stage,this.bus=this.game.bus,this.index=0,this.currentElement=0,this.sceneId=null,this.scenePath=[],this.currentCommands=[],this.wait=!1,this.startTime=Math.round(+new Date/1e3),this.stopped=!1,t=this,n=this.bus,this.buildLoadingScreen(),s=function(e){var s,i,n;if(e=e||{},i=e.element||null,s=null,null!==i)try{s="asset"===e.element.tagName?"assets":null,s="settings"===e.element.parent.tagName?"settings":null}catch(r){}switch(s=s||"scenes"){case"assets":n="         Encountered in section 'assets'.";break;case"settings":n="         Encountered in section 'settings'.";break;default:n="         Encountered in scene '"+t.sceneId+"', element "+t.currentElement+"."}console.log(n)},n.subscribe(s,"wse.interpreter.error"),n.subscribe(s,"wse.interpreter.warning"),n.subscribe(s,"wse.interpreter.message"),n.subscribe(function(){console.log("Game over.")},"wse.interpreter.end"),n.subscribe(function(){t.numberOfFunctionsToWaitFor+=1},"wse.interpreter.numberOfFunctionsToWaitFor.increase"),n.subscribe(function(){t.numberOfFunctionsToWaitFor-=1},"wse.interpreter.numberOfFunctionsToWaitFor.decrease"),n.subscribe(function(){t.assetsLoading+=1,t.assetsLoadingMax+=1},"wse.assets.loading.increase"),n.subscribe(function(){t.assetsLoading-=1,t.assetsLoaded+=1},"wse.assets.loading.decrease"),function(){var s;s=function(){var s,i,n;s=function(e){t.loadScreen.style.opacity=e},i=function(){t.loadScreen.style.display="none"},n={duration:500,onFinish:i},document.getElementById("WSELoadingScreenProgress").style.width="100%",e.fx.transform(s,1,0,n)},n.subscribe(s,"wse.assets.loading.finished")}(),this.buildAssets(),this.createTriggers(),i=function(e){return function(s){n.trigger(e,{event:s,keys:t.game.keys.keys})}},this.game.keys.forAll(i("keyup"),"up"),this.game.keys.forAll(i("keydown"),"down"),this.game.keys.forAll(i("keypress"),"press"),this.game.subscribeListeners(),setTimeout(function(){t.runStory()},1e3)},e.Interpreter.prototype.runStory=function(){var e;return e=this,this.assetsLoading>0?void function(){var t;t=function(){e.runStory()},setTimeout(t,100)}():(this.bus.trigger("wse.assets.loading.finished"),this.startTime=Math.round(+new Date/1e3),void this.changeScene(this.getFirstScene()))},e.Interpreter.prototype.getFirstScene=function(){var e,t,s;return e=this.story.getElementsByTagName("scene"),this.scenes=e,t=e.length,s=this.getSceneById("start"),null!==s?s:1>t?(this.bus.trigger("wse.interpreter.error",{message:"No scenes found!"}),null):e[0]},e.Interpreter.prototype.changeScene=function(e){this.changeSceneNoNext(e),this.next()},e.Interpreter.prototype.changeSceneNoNext=function(e){var t,s,i=this.bus;if(i.trigger("wse.interpreter.changescene.before",{scene:e,interpreter:this},!1),"undefined"==typeof e||null===e)return void i.trigger("wse.interpreter.error",{message:"Scene does not exist."});if(s=e.getAttribute("id"),this.visitedScenes.push(s),null===s)return void i.trigger("wse.interpreter.error",{message:"Encountered scene without id attribute."});for(i.trigger("wse.interpreter.message","Entering scene '"+s+"'.");this.scenePath.length>0;)this.popFromCallStack();return this.currentCommands=e.childNodes,t=this.currentCommands.length,this.index=0,this.sceneId=s,this.scenePath=[],this.currentElement=0,1>t?void i.trigger("wse.interpreter.warning",{element:e,message:"Scene '"+s+"' is empty."}):(this.numberOfFunctionsToWaitFor=0,void i.trigger("wse.interpreter.changescene.after",{scene:e,interpreter:this},!1))},e.Interpreter.prototype.pushToCallStack=function(){var e={};e.index=this.index,e.sceneId=this.sceneId,e.scenePath=this.scenePath.slice(),e.currentElement=this.currentElement,this.callStack.push(e)},e.Interpreter.prototype.popFromCallStack=function(){var e=this.callStack.pop(),t=e.scenePath.slice();for(this.bus.trigger("wse.interpreter.message","Returning from sub scene '"+this.sceneId+"' to scene '"+e.sceneId+"'...",!1),this.index=e.index+1,this.sceneId=e.sceneId,this.scenePath=e.scenePath,this.currentScene=this.getSceneById(e.sceneId),this.currentElement=e.currentElement,this.currentCommands=this.currentScene.childNodes;t.length>0;)this.currentCommands=this.currentCommands[t.shift()].childNodes},e.Interpreter.prototype.getSceneById=function(e){var t,s,i,n;for(n=null,t=0,s=this.scenes.length;s>t;t+=1)if(i=this.scenes[t],i.getAttribute("id")===e){n=i;break}return null===n&&this.bus.trigger("wse.interpreter.warning",{message:"Scene '"+e+"' not found!"}),n},e.Interpreter.prototype.next=function(e){var t,s,i,n,r,a=this.bus;if(r={stop:!1},e=e===!0?!0:!1,a.trigger("wse.interpreter.next.before",this,!1),e===!0&&a.trigger("wse.interpreter.next.user",r,!1),r.stop!==!0&&(n=this,"pause"!==this.state)){if(this.waitForTimer===!0||this.wait===!0&&this.waitCounter>0)return void setTimeout(function(){n.next()},0);if(this.wait===!0&&this.numberOfFunctionsToWaitFor<1&&(this.wait=!1),this.stopped=!1,this.index>=this.currentCommands.length)return this.callStack.length>0?(this.popFromCallStack(),void setTimeout(function(){n.next()},0)):(a.trigger("wse.interpreter.next.after.end",this,!1),void a.trigger("wse.interpreter.end",this));if(s=this.currentCommands[this.index],t=s.nodeName,"#text"===t||"#comment"===t)return this.index+=1,setTimeout(function(){n.next()},0),void a.trigger("wse.interpreter.next.ignore",this,!1);if(a.trigger("wse.interpreter.next.command",s),this.currentElement+=1,i=this.runCommand(this.currentCommands[this.index]),i=i||{},i.doNext=i.doNext===!1?!1:!0,i.wait=i.wait===!0?!0:!1,i.changeScene=i.changeScene||null,i.wait===!0&&(this.wait=!0),this.index+=1,null!==i.changeScene)return void this.changeScene(i.changeScene);if(i.doNext===!0)return setTimeout(function(){n.next()},0),void a.trigger("wse.interpreter.next.after.donext",this,!1);this.stopped=!0,a.trigger("wse.interpreter.next.after.nonext",this,!1)}},e.Interpreter.prototype.checkIfvar=function(e){var t,s,i,n,r=this.bus;if(t=e.getAttribute("ifvar")||null,s=e.getAttribute("ifvalue"),i=e.getAttribute("ifnot"),null!==t||null!==s||null!==i){if(n=this.runVars,!(t in n))return r.trigger("wse.interpreter.warning",{element:e,message:"Unknown variable '"+t+"' used in condition. Ignoring command."}),r.trigger("wse.interpreter.runcommand.after.condition.error.key",{interpreter:this,command:e},!1),!1;if(null!==i&&""+n[t]==""+i)return r.trigger("wse.interpreter.message","Conidition not met. "+t+"=="+i),r.trigger("wse.interpreter.runcommand.after.condition.false",{interpreter:this,command:e},!1),!1;if(null!==s&&""+n[t]!=""+s)return r.trigger("wse.interpreter.message","Conidition not met."),r.trigger("wse.interpreter.runcommand.after.condition.false",{interpreter:this,command:e},!1),!1;r.trigger("wse.interpreter.runcommand.condition.met",{interpreter:this,command:e},!1),r.trigger("wse.interpreter.message","Conidition met.")}return!0},e.Interpreter.prototype.runCommand=function(e){var t,s,i=this.bus;return this.bus.trigger("wse.interpreter.runcommand.before",{interpreter:this,command:e},!1),t=e.tagName,s=e.getAttribute("asset")||null,this.checkIfvar(e)?t in this.commands?(i.trigger("wse.interpreter.runcommand.after.command",{interpreter:this,command:e},!1),i.trigger("game.commands."+t),this.commands[t](e,this)):null!==s&&s in this.assets&&"function"==typeof this.assets[s][t]&&t.match(/(show|hide|clear|flicker|flash|play|start|stop|pause|move|shake|set)/)?(i.trigger("game.assets."+s+"."+t),this.assets[s][t](e,this)):(i.trigger("wse.interpreter.warning",{element:e,message:"Unknown element '"+t+"'."}),i.trigger("wse.interpreter.runcommand.after.error",{interpreter:this,command:e},!1),{doNext:!0}):{doNext:!0}},e.Interpreter.prototype.commands={},e.commands=e.Interpreter.prototype.commands,e.Interpreter.prototype.createTriggers=function(){var t,s,i,n,r,a,o,u=this.bus;u.trigger("wse.interpreter.triggers.create",this,!1),a=this,this.triggers={};try{t=this.game.ws.getElementsByTagName("triggers")[0].getElementsByTagName("trigger")}catch(c){return void console.log(c)}for(s=0,i=t.length;i>s;s+=1)n=t[s],r=n.getAttribute("name")||null,null!==r?"undefined"==typeof this.triggers[r]||null===this.triggers[r]?(o=new e.Trigger(n,this),"function"==typeof o.fn&&(this.triggers[r]=o)):u.trigger("wse.interpreter.warning",{element:n,message:"A trigger with the name '"+r+"' already exists."}):u.trigger("wse.interpreter.warning",{element:n,message:"No name specified for trigger."})},e.Interpreter.prototype.buildAssets=function(){var e,t,s,i,n=this.bus;n.trigger("wse.assets.loading.started");try{e=this.story.getElementsByTagName("assets")[0].childNodes}catch(r){n.trigger("wse.interpreter.error",{message:"Error while creating assets: "+r.getMessage()})}for(t=e.length,s=0;t>s;s+=1)i=e[s],1===i.nodeType&&this.createAsset(i)},e.Interpreter.prototype.createAsset=function(t){var s,i,n,r=this.bus;return r.trigger("wse.interpreter.createasset",{interpreter:this,asset:t},!1),s=t.getAttribute("name"),i=t.tagName,n=this,null===s?void r.trigger("wse.interpreter.error",{element:t,message:"Expected attribute 'name'."}):null===i?void r.trigger("wse.interpreter.warning",{element:t,message:"Expected attribute 'type' on asset '"+s+"'."}):("undefined"!=typeof this.assets[s]&&r.trigger("wse.interpreter.warning",{element:t,message:"Trying to override existing asset '"+s+"'."}),i=e.tools.firstLetterUppercase(i),i in e.assets?void(this.assets[s]=new e.assets[i](t,this)):(console.log(e.assets),void r.trigger("wse.interpreter.warning",{element:t,message:"Unknown asset type '"+i+"'."})))},e.Interpreter.prototype.createSaveGame=function(){var e,t,s;s={},e=this.assets;for(t in e)if(e.hasOwnProperty(t))try{s[t]=e[t].save()}catch(i){console.log("WSE Internal Error: Asset '"+t+"' does not have a 'save' method!")}return s},e.Interpreter.prototype.restoreSaveGame=function(e){var t,s;t=this.assets;for(s in t)if(t.hasOwnProperty(s))try{t[s].restore(e[s])}catch(i){console.log(i),this.bus.trigger("wse.interpreter.warning",{message:"Could not restore asset state for asset '"+s+"'!"})}},e.Interpreter.prototype.save=function(e){e=e||"no name";var t,s,i,n,r,a,o=this.bus;t={},o.trigger("wse.interpreter.save.before",{interpreter:this,savegame:t},!1),t.saves=this.createSaveGame(),t.startTime=this.startTime,t.saveTime=Math.round(+new Date/1e3),t.screenContents=this.stage.innerHTML,t.runVars=this.runVars,t.name=e,t.log=this.log,t.visitedScenes=this.visitedScenes,t.gameUrl=this.game.url,t.index=this.index,t.wait=this.wait,t.waitForTimer=this.waitForTimer,t.currentElement=this.currentElement,t.sceneId=this.sceneId,t.scenePath=this.scenePath,t.listenersSubscribed=this.game.listenersSubscribed,t.callStack=this.callStack,t.waitCounter=this.waitCounter,t.pathname=location.pathname,i=this.buildSavegameId(e),s=JSON.stringify(t),r="wse_"+t.pathname+"_"+t.gameUrl+"_savegames_list",n=JSON.parse(this.datasource.get(r)),n=n||[],a=n.indexOf(i),a>=0&&n.splice(a,1),n.push(i);try{this.datasource.set(i,s),this.datasource.set(r,JSON.stringify(n))}catch(u){return o.trigger("wse.interpreter.warning",{message:"Savegame could not be created!"}),o.trigger("wse.interpreter.save.after.error",{interpreter:this,savegame:t},!1),!1}return o.trigger("wse.interpreter.save.after.success",{interpreter:this,savegame:t}),!0},e.Interpreter.prototype.getSavegameList=function(e){var t,s,i,n,r,a;if(s="wse_"+location.pathname+"_"+this.game.url+"_savegames_list",t=this.datasource.get(s),null===t)return[];for(i=JSON.parse(t),a=[],n=0,r=i.length;r>n;n+=1)e===!0?a.unshift(JSON.parse(this.datasource.get(i[n]))):a.push(JSON.parse(this.datasource.get(i[n])));return this.bus.trigger("wse.interpreter.getsavegamelist",{interpreter:this,list:a,names:i},!1),a},e.Interpreter.prototype.buildSavegameId=function(e){var t={};return t.name=e,t.id="wse_"+location.pathname+"_"+this.game.url+"_savegame_"+e,this.bus.trigger("wse.interpreter.save.before",{interpreter:this,vars:t},!1),t.id},e.Interpreter.prototype.load=function(e){var t,s,i,n,r,a,o,u,c,h,l=this.bus;if(c=this,h=this.buildSavegameId(e),t=this.datasource,s=t.get(h),l.trigger("wse.interpreter.load.before",{interpreter:this,savegame:s},!1),!s)return l.trigger("wse.interpreter.warning",{message:"Could not load savegame '"+h+"'!"}),!1;for(s=JSON.parse(s),this.stage.innerHTML=s.screenContents,this.restoreSaveGame(s.saves),this.startTime=s.startTime,this.runVars=s.runVars,this.log=s.log,this.visitedScenes=s.visitedScenes,this.index=s.index,this.wait=s.wait,this.waitForTimer=s.waitForTimer,this.currentElement=s.currentElement,this.callStack=s.callStack,this.waitCounter=s.waitCounter,this.state="listen",n=s.sceneId,this.sceneId=n,a=this.story.getElementsByTagName("scene"),this.scenes=a,o=0,u=this.scenes.length;u>o;o+=1)if(a[o].getAttribute("id")===n){i=a[o];break}if(!i)return l.trigger("wse.interpreter.error",{message:"Loading savegame '"+h+"' failed: Scene not found!"}),!1;for(r=s.scenePath,this.scenePath=r.slice(),this.currentCommands=i.childNodes;r.length>0;)this.currentCommands=this.currentCommands[r.shift()].childNodes;return function(e){var t,s,i,n,r,a,o,u;for(t=e.stage.getElementsByTagName("*"),s=0,i=t.length;i>s;s+=1)n=t[s],"undefined"!=typeof n&&null!==n&&(a=n.getAttribute("data-wse-type")||"",u="true"===n.getAttribute("data-wse-remove")?!0:!1,u===!0&&e.stage.removeChild(n),"choice"===a&&(r=parseInt(n.getAttribute("data-wse-index"),10)||null,null!==r?(o=e.currentCommands[r],"#text"!==o.nodeName&&"#comment"!==o.nodeName&&(e.stage.removeChild(n),e.commands.choice(o,e),e.waitCounter-=1)):e.bus.trigger("wse.interpreter.warning",{message:"No data-wse-index found on element."})))}(this),l.trigger("wse.interpreter.load.after",{interpreter:this,savegame:s},!1),!0},e.Interpreter.prototype.deleteSavegame=function(e){var t,s,i,n,r;return s="wse_"+location.pathname+"_"+this.game.url+"_savegames_list",n=this.datasource.get(s),null===n?!1:(t=JSON.parse(n),r=this.buildSavegameId(e),i=t.indexOf(r),i>=0?(t.splice(i,1),this.datasource.set("wse_"+location.pathname+"_"+this.game.url+"_savegames_list",JSON.stringify(t)),this.datasource.remove(r),!0):!1)},e.Interpreter.prototype.toggleSavegameMenu=function(){var t,s,i,n,r,a,o,u,c,h,l,d,g,m,p,f,b,y;if(r=this,l="WSESaveGameMenu_"+this.game.url,f=this.game.listenersSubscribed,t=document.getElementById(l)||null,null!==t){try{f="true"===t.getAttribute("data-wse-listener-status")?!0:!1,this.stage.removeChild(t)}catch(v){console.log(v)}return f===!0&&(this.savegameMenuVisible=!1),this.state=this.oldStateInSavegameMenu,void(this.waitCounter-=1)}if(this.stopped!==!0)return void setTimeout(function(){r.toggleSavegameMenu()},20);for(y=this.state,this.oldStateInSavegameMenu=y,this.state="pause",this.waitCounter+=1,this.savegameMenuVisible=!0,t=document.createElement("div"),t.innerHTML="",t.setAttribute("id",l),t.setAttribute("class","WSESavegameMenu"),t.setAttribute("data-wse-remove","true"),t.setAttribute("data-wse-listener-status",f),t.style.zIndex=1e5,t.style.position="absolute",a=this.getSavegameList(!0),s=document.createElement("input"),s.setAttribute("class","button delete"),s.setAttribute("type","button"),s.value="Delete",s.addEventListener("click",function(s){var i,n,a;s.stopPropagation(),s.preventDefault(),i=t.querySelector(".active")||null,null!==i&&(n=i.getAttribute("data-wse-savegame-name"),a=function(e){e!==!1&&(r.deleteSavegame(n),r.toggleSavegameMenu(),r.toggleSavegameMenu())},e.tools.ui.confirm(r,{title:"Delete game?",message:"Do you really want to delete savegame '"+n+"'?",callback:a}))},!1),n=document.createElement("input"),n.setAttribute("class","button save"),n.setAttribute("type","button"),n.value="Save",n.addEventListener("click",function(s){var i,n;return s.stopPropagation(),s.preventDefault(),i=t.querySelector(".active")||null,null===i?void e.tools.ui.prompt(r,{title:"New savegame",message:"Please enter a name for the savegame:",callback:function(t){if(null!==t){if(!t)return void e.tools.ui.alert(r,{title:"Error",message:"The savegame name cannot be empty!"});r.toggleSavegameMenu(),r.game.listenersSubscribed=f,r.save(t),r.toggleSavegameMenu(),r.game.listenersSubscribed=!1,e.tools.ui.alert(r,{title:"Game saved",message:"Your game has been saved."})}}}):(n=i.getAttribute("data-wse-savegame-name"),void e.tools.ui.confirm(r,{title:"Overwrite savegame?",message:"You are about to overwrite an old savegame. Are you sure?",trueText:"Yes",falseText:"No",callback:function(t){t!==!1&&(r.toggleSavegameMenu(),r.save(n),r.toggleSavegameMenu(),e.tools.ui.alert(r,{title:"Game saved",message:"Your game has been saved."}))}}))},!1),i=document.createElement("input"),i.setAttribute("class","button load"),i.setAttribute("type","button"),i.setAttribute("tabindex",1),i.value="Load",i.addEventListener("click",function(s){var i,n,a;s.stopPropagation(),s.preventDefault(),i=t.querySelector(".active")||null,null!==i&&(n=i.getAttribute("data-wse-savegame-name"),a=function(e){e!==!1&&(r.stage.removeChild(document.getElementById(l)),r.savegameMenuVisible=!1,r.waitCounter-=1,r.state=y,r.load(n))},e.tools.ui.confirm(r,{title:"Load game?",message:"Loading a savegame will discard all unsaved progress. Continue?",callback:a}))},!1),c=document.createElement("div"),c.setAttribute("class","panel"),h=document.createElement("input"),h.setAttribute("class","button resume"),h.setAttribute("type","button"),h.value="Resume",h.addEventListener("click",function(e){e.stopPropagation(),e.preventDefault(),r.stage.removeChild(document.getElementById(l)),r.bus.trigger("wse.interpreter.numberOfFunctionsToWaitFor.decrease",null,!1),r.savegameMenuVisible=!1,r.waitCounter-=1,r.state=y},!1),d=document.createElement("div"),d.setAttribute("class","list"),c.appendChild(i),c.appendChild(n),c.appendChild(s),c.appendChild(h),t.appendChild(c),p=function(e){return function(t){var s;t.stopPropagation(),t.preventDefault();try{s=d.querySelector(".active")||null,null!==s&&s.setAttribute("class",s.getAttribute("class").replace(/active/,""))}catch(n){console.log(n)}e.setAttribute("class",e.getAttribute("class")+" active"),i.focus()}},m=document.createElement("div"),m.setAttribute("class","button"),o=0,u=a.length;u>o;o+=1)g=a[o],m=document.createElement("div"),b=g.saveTime-g.startTime,m.setAttribute("class","button"),m.setAttribute("data-wse-savegame-name",g.name),m.innerHTML='<p class="name">'+g.name+'</p><p class="description"><span class="elapsed">'+parseInt(b/60/60,10)+"h "+parseInt(b/60%60,10)+"m "+parseInt(b%60,10)+'s</span><span class="date">'+new Date(1e3*g.saveTime).toUTCString()+"</span></p>",m.addEventListener("click",p(m,g),!1),d.appendChild(m);t.addEventListener("click",function(e){var s;e.stopPropagation(),e.preventDefault(),s=t.querySelector(".active")||null,null!==s&&s.setAttribute("class",s.getAttribute("class").replace(/active/,""))},!1),t.appendChild(d),this.stage.appendChild(t)}}(WSE),function(e){"use strict";e.tools.ui={confirm:function(e,t){var s,i,n,r,a,o,u,c,h,l,d,g,m,p,f;e.waitCounter+=1,t=t||{},s=t.title||"Confirm?",i=t.message||"Do you want to proceed?",n=t.trueText||"Yes",r=t.falseText||"No",a="function"==typeof t.callback?t.callback:function(){},o=t.parent||e.stage,m=t.pause===!0?!0:!1,p=e.state,f=t.doNext===!0?!0:!1,m===!0&&(e.state="pause"),g=document.createElement("div"),g.setAttribute("class","WSEUIContainer"),g.setAttribute("data-wse-remove","true"),u=document.createElement("div"),u.setAttribute("class","WSEUIDialog WSEUIConfirm"),c=document.createElement("div"),c.innerHTML=s,c.setAttribute("class","title"),h=document.createElement("div"),h.innerHTML=i,h.setAttribute("class","message"),l=document.createElement("input"),l.setAttribute("value",n),l.value=n,l.setAttribute("class","true button"),l.setAttribute("type","button"),l.addEventListener("click",function(t){t.stopPropagation(),t.preventDefault(),o.removeChild(g),e.waitCounter-=1,m===!0&&(e.state=p),a(!0),f===!0&&setTimeout(function(){e.next()},0)}),d=document.createElement("input"),d.setAttribute("value",r),d.value=r,d.setAttribute("class","false button"),d.setAttribute("type","button"),d.addEventListener("click",function(t){t.stopPropagation(),t.preventDefault(),o.removeChild(g),e.waitCounter-=1,m===!0&&(e.state=p),a(!1),f===!0&&setTimeout(function(){e.next()},0)}),u.appendChild(c),u.appendChild(h),u.appendChild(l),u.appendChild(d),g.appendChild(u),o.appendChild(g),l.focus()},alert:function(e,t){var s,i,n,r,a,o,u,c,h,l,d,g,m;e.waitCounter+=1,t=t||{},s=t.title||"Alert!",i=t.message||"Please take notice of this!",n=t.okText||"OK",r="function"==typeof t.callback?t.callback:function(){},a=t.parent||e.stage,d=t.pause===!0?!0:!1,g=e.state,m=t.doNext===!0?!0:!1,d===!0&&(e.state="pause"),l=document.createElement("div"),l.setAttribute("class","WSEUIContainer"),l.setAttribute("data-wse-remove","true"),o=document.createElement("div"),o.setAttribute("class","WSEUIDialog WSEUIConfirm"),u=document.createElement("div"),u.innerHTML=s,u.setAttribute("class","title"),c=document.createElement("div"),c.innerHTML=i,c.setAttribute("class","message"),h=document.createElement("input"),h.setAttribute("value",n),h.value=n,h.setAttribute("class","true button"),h.setAttribute("type","button"),h.addEventListener("click",function(t){t.stopPropagation(),t.preventDefault(),a.removeChild(l),e.waitCounter-=1,d===!0&&(e.state=g),r(!0),m===!0&&setTimeout(function(){e.next()},0)}),o.appendChild(u),o.appendChild(c),o.appendChild(h),l.appendChild(o),a.appendChild(l),h.focus()},prompt:function(e,t){var s,i,n,r,a,o,u,c,h,l,d,g,m,p,f,b,y;e.waitCounter+=1,t=t||{},s=t.title||"Input required",i=t.message||"Please enter something:",n=t.submitText||"Submit",r=t.cancelText||"Cancel",f=t.defaultValue||"",a="function"==typeof t.callback?t.callback:function(){},o=t.parent||e.stage,b=t.pause===!0?!0:!1,c=e.state,y=t.doNext===!0?!0:!1,b===!0&&(e.state="pause"),p=document.createElement("div"),p.setAttribute("class","WSEUIContainer"),p.setAttribute("data-wse-remove","true"),u=document.createElement("div"),u.setAttribute("class","WSEUIDialog WSEUIPrompt"),h=document.createElement("div"),h.innerHTML=s,h.setAttribute("class","title"),l=document.createElement("div"),l.innerHTML=i,l.setAttribute("class","message"),m=document.createElement("input"),m.setAttribute("value",f),m.value=f,m.setAttribute("class","input text"),m.setAttribute("type","text"),d=document.createElement("input"),d.setAttribute("value",n),d.value=n,d.setAttribute("class","submit button"),d.setAttribute("type","button"),d.addEventListener("click",function(t){var s;s=m.value,t.stopPropagation(),t.preventDefault(),o.removeChild(p),e.waitCounter-=1,b===!0&&(e.state=c),a(s),y===!0&&setTimeout(function(){e.next()},0)}),g=document.createElement("input"),g.setAttribute("value",r),g.value=r,g.setAttribute("class","cancel button"),g.setAttribute("type","button"),g.addEventListener("click",function(t){t.stopPropagation(),t.preventDefault(),o.removeChild(p),e.waitCounter-=1,b===!0&&(e.state=c),a(null),y===!0&&setTimeout(function(){e.next()},0)}),u.appendChild(h),u.appendChild(l),u.appendChild(m),u.appendChild(d),u.appendChild(g),p.appendChild(u),o.appendChild(p),m.focus()}}}(WSE),function(e){"use strict";var t=function(t){return function(s,i){var n,r,a,o,u;return n=s.getAttribute("title")||"Input required...",r=s.getAttribute("message")||"Your input is required:",o=s.getAttribute("var")||null,u="false"===s.getAttribute("next")?!1:!0,null===o?(i.bus.trigger("wse.interpreter.warning",{element:s,message:"No 'var' attribute defined on "+t+" command. Command ignored."}),{doNext:!0}):(a=i.runVars,e.tools.ui[t](i,{title:n,message:r,pause:!0,doNext:u,callback:function(e){a[o]=""+e}}),{doNext:!0})}};e.commands.alert=function(t,s){var i,n,r;return i=t.getAttribute("title")||"Alert!",n=t.getAttribute("message")||"Alert!",n=e.tools.textToHtml(n),r="false"===t.getAttribute("next")?!1:!0,e.tools.ui.alert(s,{title:i,message:n,pause:!0,doNext:r}),{doNext:!0}},e.commands.confirm=t("confirm"),e.commands.prompt=t("prompt")}(WSE),function(e){"use strict";e.assets.mixins.displayable.flash=function(t,s){var i,n,r,a,o,u,c,h,l,d=e.fx;return s=s||{},i=this,r="yes"===t.getAttribute("wait")?!0:!1,n=t.getAttribute("duration")||500,h=t.getAttribute("opacity")||1,(u=s.element||document.getElementById(this.cssid))?(a=s.bus||this.bus,o=s.stage||this.stage,c=s.animation===!0?!0:!1,l=+u.style.opacity.replace(/[^0-9\.]/,"")>0?!0:!1,c||(i.interpreter.waitCounter+=1),d.transform(function(e){u.style.opacity=e},l?h:0,l?0:h,{duration:n/3,onFinish:function(){var e,t,s;e=function(e){u.style.opacity=e},t=function(){i.interpreter.waitCounter-=1},s={duration:n/3*2,onFinish:c?null:t,easing:d.easing.easeInQuad},d.transform(e,l?0:h,l?h:0,s)},easing:d.easing.easeInQuad}),a.trigger("wse.assets.mixins.flash",this),{doNext:!0}):void this.bus.trigger("wse.interpreter.warning",{element:t,message:"DOM Element for asset is missing!"})}}(WSE),function(e){"use strict";e.assets.mixins.displayable.flicker=function(t,s){var i,n,r,a,o,u,c,h,l,d,g,m,p,f,b,y=e.fx;return s=s||{},i=this,n=t.getAttribute("duration")||500,o=t.getAttribute("times")||10,g=t.getAttribute("opacity")||1,c=s.element||document.getElementById(this.cssid),u=n/o,d=0,c?(parseInt(c.style.opacity,10)?(p=0,m=g,b=u/3,f=2*b):(m=0,p=g,f=u/3,b=2*f),r=s.bus||this.bus,a=s.stage||this.stage,h=s.animation===!0?!0:!1,h||(i.interpreter.waitCounter+=1),l=function(){d+=1,y.transform(function(e){c.style.opacity=e},m,p,{duration:f,onFinish:function(){y.transform(function(e){c.style.opacity=e},p,m,{duration:b,onFinish:function(){return o>=d?void setTimeout(l,0):void(h||(i.interpreter.waitCounter-=1))},easing:y.easing.easeInQuad})},easing:y.easing.easeInQuad})},l(),r.trigger("wse.assets.mixins.flicker",this),{doNext:!0}):void this.bus.trigger("wse.interpreter.warning",{element:t,message:"DOM Element for asset is missing!"})}}(WSE),function(e){"use strict";e.assets.mixins.displayable.hide=function(t,s){var i,n,r,a,o,u,c,h,l,d,g,m,p,f,b,y,v,w,x=e.fx,k=e.tools.getParsedAttribute;if(s=s||{},i=this,r="yes"===k(t,"wait",this.interpreter)?!0:!1,n=k(t,"duration",this.interpreter,500),a=k(t,"effect",this.interpreter,"fade"),o=k(t,"direction",this.interpreter,"left"),m=s.animation===!0?!0:!1,p=document.getElementById(this.cssid),f=k(t,"easing",this.interpreter,"sineEaseOut"),b=null!==typeof x.easing[f]?x.easing[f]:x.easing.sineEaseOut,y=this.stage,v=this.xUnit||"px",w=this.yUnit||"px","slide"===a){switch(p.style.opacity=1,"%"===v?(h=p.offsetLeft/(y.offsetWidth/100),u=100):(h=p.offsetLeft,u=y.offsetWidth),"%"===w?(l=p.offsetTop/(y.offsetHeight/100),c=100):(l=p.offsetTop,c=y.offsetHeight),o){case"left":d=h-u,g="left";break;case"right":d=h+u,g="left";break;case"top":d=l-c,g="top";break;case"bottom":d=l+c,g="top";break;default:d=h-u,g="left"}m||(i.interpreter.waitCounter+=1),function(){var e,t,s,r;e=function(e){p.style[g]=e+("left"===g?v:w)
},t="left"===g?h:l,s=function(){switch(m||(i.interpreter.waitCounter-=1),p.style.opacity=0,o){case"left":case"right":p.style.left=h+v,g="left";break;case"top":case"bottom":p.style.top=l+w,g="top";break;default:p.style.left=h+v,g="left"}},r={duration:n,easing:b,onFinish:s},x.transform(e,t,d,r)}()}else m||(i.interpreter.waitCounter+=1),function(){var e,t,s;e=function(e){p.style.opacity=e},s=function(){m||(i.interpreter.waitCounter-=1),p.style.opacity=0},t={duration:n,easing:b,onFinish:s},x.transform(e,1,0,t)}();return this.bus.trigger("wse.assets.mixins.hide",this),{doNext:!0}}}(WSE),function(e){"use strict";e.assets.mixins.displayable.move=function(t,s){var i,n,r,a,o,u,c,h,l,d,g,m,p,f,b,y,v,w,x,k,A,E,I,S=e.fx,C=this.interpreter;return s=s||{},o=this,a=document.getElementById(this.cssid),i=t.getAttribute("x"),n=t.getAttribute("y"),r=t.getAttribute("z"),x=t.getAttribute("xAnchor"),k=t.getAttribute("yAnchor"),null===x&&null!==this.xAnchor&&(x=this.xAnchor),null===k&&null!==this.yAnchor&&(k=this.yAnchor),i=e.tools.replaceVariables(i,this.interpreter),n=e.tools.replaceVariables(n,this.interpreter),r=e.tools.replaceVariables(r,this.interpreter),x=e.tools.replaceVariables(x,this.interpreter),k=e.tools.replaceVariables(k,this.interpreter),l=e.tools.getParsedAttribute(t,"duration",C,500),d=e.tools.getParsedAttribute(t,"easing",C,"sineEaseOut"),g=null!==typeof S.easing[d]?S.easing[d]:S.easing.sineEaseOut,b=s.animation===!0?!0:!1,w=this.interpreter.stage,A=a.offsetLeft,E=a.offsetTop,null!==i&&(c=e.tools.extractUnit(i),i=parseInt(i,10)),null!==n&&(h=e.tools.extractUnit(n),n=parseInt(n,10)),I=a.style.display,a.style.display="","%"===c&&(i=w.offsetWidth/100*i,c="px"),"%"===h&&(n=w.offsetHeight/100*n,h="px"),i=e.tools.calculateValueWithAnchor(i,x,a.offsetWidth),n=e.tools.calculateValueWithAnchor(n,k,a.offsetHeight),a.style.display=I,u="yes"===e.tools.getParsedAttribute(t,"wait",C)?!0:!1,m=!1,p=!1,f=!1,null===i&&null===n&&null===r&&this.bus.trigger("wse.interpreter.warning",{element:t,message:"Can't apply command 'move' to asset '"+this.name+"' because no x, y or z position has been supplied."}),null!==i&&(y="%"===c?A/(w.offsetWidth/100):A,b||(o.interpreter.waitCounter+=1),S.transform(function(e){a.style.left=e+c},y,i,{onFinish:b?null:function(){o.interpreter.waitCounter-=1},duration:l,easing:g})),null!==n&&(v="%"===h?E/(w.offsetHeight/100):E,b||(o.interpreter.waitCounter+=1),S.transform(function(e){a.style.top=e+h},v,n,{onFinish:b?null:function(){o.interpreter.waitCounter-=1},duration:l,easing:g})),null!==r&&(b||(o.interpreter.waitCounter+=1),S.transform(function(e){a.style.zIndex=e},a.style.zIndex||0,parseInt(r,10),{onFinish:b?null:function(){o.interpreter.waitCounter-=1},duration:l,easing:g})),this.bus.trigger("wse.assets.mixins.move",this),{doNext:!0}}}(WSE),function(e){"use strict";e.assets.mixins.displayable.shake=function(t,s){var i,n,r,a,o,u,c,h,l,d,g,m,p,f=e.fx;return s=s||{},a=this,r=document.getElementById(this.cssid),i=t.getAttribute("dx"),n=t.getAttribute("dy"),h=t.getAttribute("period")||50,c=t.getAttribute("duration")||275,d=s.animation===!0?!0:!1,p=this.interpreter.stage,null===i&&null===n&&(n="-10px"),null!==i&&(o=e.tools.extractUnit(i),i=parseInt(i,10)),null!==n&&(u=e.tools.extractUnit(n),n=parseInt(n,10)),l=function(e,t){for(var s=t/h;s>2;)s-=2;return s>1&&(s=2-s),s},null!==i&&(g="%"===o?r.offsetLeft/(p.offsetWidth/100):r.offsetLeft,a.interpreter.waitCounter+=1,f.transform(function(e){r.style.left=e+o},g-i,g+i,{onFinish:function(){r.style.left=g+o,a.interpreter.waitCounter-=1},duration:c,easing:l})),null!==n&&(m="%"===u?r.offsetTop/(p.offsetHeight/100):r.offsetTop,a.interpreter.waitCounter+=1,f.transform(function(e){r.style.top=e+u},m-n,m+n,{onFinish:function(){r.style.top=m+u,a.interpreter.waitCounter-=1},duration:c,easing:l})),this.bus.trigger("wse.assets.mixins.shake",this),{doNext:!0}}}(WSE),function(e){"use strict";e.assets.mixins.displayable.show=function(t,s){var i,n,r,a,o,u,c,h,l,d,g,m,p,f,b,y,v,w,x,k,A,E=e.fx,I=e.tools.getParsedAttribute;if(s=s||{},i=this,r="yes"===I(t,"wait",this.interpreter)?!0:!1,n=I(t,"duration",this.interpreter,500),a=I(t,"effect",this.interpreter,"fade"),o=I(t,"direction",this.interpreter,"right"),p=s.element||document.getElementById(this.cssid),l=this.xUnit||"px",d=this.yUnit||"px",console.log("duration:",n),!p)return void this.bus.trigger("wse.interpreter.warning",{element:t,message:"DOM Element for asset is missing!"});if(v=s.interpreter||this.interpreter,g=s.bus||this.bus,m=s.stage||this.stage,y=I(t,"easing",this.interpreter,"sineEaseOut"),b=null!==typeof E.easing[y]?E.easing[y]:E.easing.sineEaseOut,f=s.animation===!0?!0:!1,"slide"===a){switch("%"===l?(u=p.offsetLeft/(m.offsetWidth/100),w=100):(u=p.offsetLeft,w=m.offsetWidth),"%"===d?(c=p.offsetTop/(m.offsetHeight/100),x=100):(c=p.offsetTop,x=m.offsetHeight),o){case"left":p.style.left=u+w+l,h="left";break;case"right":p.style.left=u-w+l,h="left";break;case"top":p.style.top=c+x+d,h="top";break;case"bottom":p.style.top=c-x+d,h="top";break;default:p.style.left=u-w+l,h="left"}p.style.opacity=1,f||(v.waitCounter+=1),k="%"===l?p.offsetLeft/(m.offsetWidth/100):p.offsetLeft,A="%"===d?p.offsetTop/(m.offsetHeight/100):p.offsetTop,E.transform(function(e){p.style[h]=e+("left"===h?l:d)},"left"===h?k:A,"left"===h?u:c,{duration:n,onFinish:f?null:function(){v.waitCounter-=1},easing:b})}else f||(v.waitCounter+=1),E.transform(function(e){p.style.opacity=e},0,1,{duration:n,onFinish:f?null:function(){v.waitCounter-=1},easing:b});return g.trigger("wse.assets.mixins.show",this),{doNext:!0}}}(WSE),function(e){"use strict";e.assets.Animation=function(t,s){var i,n,r,a,o,u,c,h,l,d,g;if(!(this instanceof e.assets.Animation))return new e.assets.Animation(t,s);if(this.stage=s.stage,this.bus=s.bus,this.asset=t,this.name=t.getAttribute("name"),this.cbs=[],this.assets=s.assets,this.id=e.tools.getUniqueId(),this.isRunning=!1,c=this,i=this.asset.getElementsByTagName("group"),r=i.length,1>r)return this.bus.trigger("wse.interpreter.warning",{element:t,message:"Animation asset '"+this.name+"' is empty."}),{doNext:!0};for(l=function(t,s,i,n,r,a){return e.fx.transform(function(e){t.style[n]=e+r},s,i,a)},g=function(t,i){var n,r;r=t,n=r.getAttribute("duration"),s.commands["do"](r,s,{animation:!0}),null!==n&&i.push(e.fx.createTimer(n))},d=function(t,s){var i;i=s.length,u=o.length,c.cbs.push(function(){var n,r,a,o,h,d,m,p,f,b,y,v,w=[];for(f=0;u>f;f+=1)if(o=t[f],"undefined"!=typeof o&&null!==o){d=o.getAttribute("asset");try{h=document.getElementById(c.assets[d].cssid)||c.stage}catch(x){continue}b=o.getAttribute("easing"),n=parseInt(o.getAttribute("from"),10),r=parseInt(o.getAttribute("to"),10),a=o.getAttribute("unit")||"",m=o.getAttribute("duration")||500,p=o.getAttribute("property"),y={},y.duration=m,null!==b&&"undefined"!=typeof e.fx.easing[b]&&null!==e.fx.easing[b]&&(y.easing=e.fx.easing[b]),w.push(l(h,n,r,p,a,y))}for(v=0;i>v;v+=1)g(s[v],w);return w})},n=0;r>n;n+=1)a=i[n],o=a.getElementsByTagName("transform"),h=a.getElementsByTagName("do"),d(o,h);this.anim=new e.fx.Animation(this.cbs),this.bus.trigger("wse.assets.animation.constructor",this),function(){var e;e=function(){c.stop()},c.bus.subscribe(e,"wse.interpreter.restart"),c.bus.subscribe(e,"wse.interpreter.end"),c.bus.subscribe(e,"wse.interpreter.load.before")}()},e.assets.Animation.prototype.start=function(){this.anim.start(),this.isRunning=!0,this.bus.trigger("wse.assets.animation.started",this)},e.assets.Animation.prototype.stop=function(){this.anim.stop(),this.isRunning=!1,this.bus.trigger("wse.assets.animation.stopped",this)},e.assets.Animation.prototype.save=function(){var e={assetType:"Animation",isRunning:this.isRunning,index:this.anim.index};return this.bus.trigger("wse.assets.animation.save",{subject:this,saves:e}),e},e.assets.Animation.prototype.restore=function(e){this.isRunning=e.isRunning,this.isRunning===!0&&(this.anim.index=e.index,this.start()),this.bus.trigger("wse.assets.animation.restore",{subject:this,saves:e})}}(WSE),function(e){"use strict";e.assets.Audio=function(t,s){var i,n,r,a,o,u,c,h,l,d,g,m,p,f,b;if(b=s.bus,i=this,this.au=new Audio,this.au.setAttribute("preload","auto"),this.bus=b,this.name=t.getAttribute("name"),this.tracks={},this.current=null,this.currentIndex=null,this.autopause="true"===t.getAttribute("autopause")?!0:!1,this.loop="true"===t.getAttribute("loop")?!0:!1,this.fade="true"===t.getAttribute("fade")?!0:!1,this.fadeinDuration=parseInt(t.getAttribute("fadein"))||1e3,this.fadeoutDuration=parseInt(t.getAttribute("fadeout"))||1e3,this.id=e.tools.getUniqueId(),this.locked=!1,f=t.getElementsByTagName("track"),a=f.length,1>a)return this.bus.trigger("wse.interpreter.warning",{element:t,message:"No tracks defined for audio element '"+this.name+"'."}),{doNext:!0};for(r=0;a>r;r+=1)if(c=f[r],n=c.getElementsByTagName("source"),u=n.length,1>u)this.bus.trigger("wse.interpreter.warning",{element:t,message:"No sources defined for track '"+l+"' in audio element '"+this.name+"'."});else if(h=new Audio,h.setAttribute("preload","auto"),this.loop&&(h.loop=!0),d={},l=c.getAttribute("title"),null!==l){for(o=0;u>o;o+=1)p=n[o],g=p.getAttribute("href"),m=p.getAttribute("type"),null!==g?null!==m?d[m]=g:this.bus.trigger("wse.interpreter.warning",{element:t,message:"No type defined for source in track '"+l+"' in audio element '"+this.name+"'."}):this.bus.trigger("wse.interpreter.warning",{element:t,message:"No href defined for source in track '"+l+"' in audio element '"+this.name+"'."});if(h.canPlayType("audio/mpeg")&&"undefined"!=typeof d.mp3)h.src=d.mp3;else{if("undefined"==typeof d.ogg){this.bus.trigger("wse.interpreter.warning",{element:t,message:"No usable source found for track '"+l+"' in audio element '"+this.name+"'."});continue}h.src=d.ogg}s.stage.appendChild(h),this.tracks[l]=h}else this.bus.trigger("wse.interpreter.warning",{element:t,message:"No title defined for track '"+l+"' in audio element '"+this.name+"'."});this.isPlaying=!1,this.renewCurrent=function(){var e,t;e=new Audio,e.setAttribute("preload","auto"),t=i.current.src;try{s.stage.removeChild(i.current)}catch(n){console.log(n)}e.src=t,i.current=e,i.tracks[i.currentIndex]=e,s.stage.appendChild(e)},this.play=function(s){s=s||document.createElement("div");var n="true"===s.getAttribute("fade")?!0:"false"===s.getAttribute("fade")?!1:this.fade,r=parseInt(s.getAttribute("fadein"))||this.fadeinDuration;return null===i.current?void this.bus.trigger("wse.interpreter.warning",{element:t,message:"No usable source found for track '"+l+"' in audio element '"+this.name+"'."}):(i.isPlaying===!0&&i.stop(s),i.isPlaying=!0,i.loop===!0?e.tools.attachEventListener(i.current,"ended",function(){i.renewCurrent(),setTimeout(function(){i.play()},0)}):e.tools.attachEventListener(i.current,"ended",function(){i.isPlaying=!1}),n===!0?(i.current.volume=1e-4,i.current.play(),i.fadeIn(r)):i.current.play(),this.bus.trigger("wse.assets.audio.play",this),{doNext:!0})},this.stop=function(e){e=e||document.createElement("div");var s="true"===e.getAttribute("fade")?!0:"false"===e.getAttribute("fade")?!1:i.fade,n=parseInt(e.getAttribute("fadeout"))||i.fadeoutDuration;return null===i.current?(this.bus.trigger("wse.interpreter.warning",{element:t,message:"No track set for audio element '"+this.name+"'."}),{doNext:!0}):(s===!0?i.fadeOut(n,function(){i.current.pause(),i.currentTime=.1,i.renewCurrent(),i.isPlaying=!1}):(i.current.pause(),i.currentTime=.1,i.renewCurrent(),i.isPlaying=!1),this.bus.trigger("wse.assets.audio.stop",this),{doNext:!0})},this.pause=function(){return this.current.pause(),{doNext:!0}},this.fadeIn=function(e){var t;return t=function(){if(i.locked===!1){var s=i.current.volume+10/e;i.current.volume=1>s?s:1}i.current.volume<1&&setTimeout(t,10)},setTimeout(t,10),{doNext:!0}},this.fadeOut=function(e,t){var s;return t="function"==typeof t?t:function(){},s=function(){var n=i.current.volume-10/e;i.current.volume=n>0?n:0,i.current.volume>0?(i.locked=!0,setTimeout(s,10)):(i.locked=!1,t())},setTimeout(s,10),{doNext:!0}},this.autopause!==!1&&(e.tools.attachEventListener(window,"blur",function(){i.isPlaying===!0&&i.fadeOut(1e3,function(){i.current.pause()})}),e.tools.attachEventListener(window,"focus",function(){i.isPlaying===!0&&(i.current.play(),i.fadeIn(1e3))}),this.bus.trigger("wse.assets.audio.constructor",this))},e.assets.Audio.prototype.set=function(e){var t,s,i,n="true"===e.getAttribute("fade")?!0:"false"===e.getAttribute("fade")?!1:this.fade,r=parseInt(e.getAttribute("fadeout"))||this.fadeoutDuration;return i=this,t=e.getAttribute("track"),s=this.isPlaying,"undefined"==typeof this.tracks[t]||null===this.tracks[t]?(this.bus.trigger("wse.interpreter.warning",{element:e,message:"Unknown track '"+t+"' in audio element '"+this.name+"'."}),{doNext:!0}):(s===!0&&n===!0?i.fadeOut(r,function(){i.current.pause(),i.currentTime=.1,i.renewCurrent(),i.isPlaying=!1,i.currentIndex=t,i.current=i.tracks[t],i.play(e)}):(s===!0&&this.stop(e),this.currentIndex=t,this.current=this.tracks[t],s===!0&&this.play(e)),this.bus.trigger("wse.assets.audio.set",this),{doNext:!0})},e.assets.Audio.prototype.save=function(){var e={assetType:"Audio",isPlaying:this.isPlaying,fade:this.fade,fadeinDuration:this.fadeinDuration,fadeoutDuration:this.fadeoutDuration,currentIndex:this.currentIndex,currentTime:0};return this.isPlaying&&(e.currentTime=this.current.currentTime),this.bus.trigger("wse.assets.audio.save",this),e},e.assets.Audio.prototype.restore=function(e){this.isPlaying=e.isPlaying,this.fade=e.fade,this.fadeinDuration=e.fadeinDuration,this.fadeoutDuration=e.fadeoutDuration,this.currentIndex=e.currentIndex,this.tracks[this.currentIndex]&&(this.current=this.tracks[this.currentIndex],this.current.currentTime=e.currentTime),this.locked=!1,this.isPlaying?(this.fade=!1,this.play(),this.fade=e.fade):this.stop(),this.bus.trigger("wse.assets.audio.restore",this)}}(WSE),function(e){"use strict";e.assets.Character=function(t,s){this.asset=t,this.stage=s.stage,this.bus=s.bus,this.id=e.tools.getUniqueId(),this.name=t.getAttribute("name"),this.bus.trigger("wse.assets.character.constructor",this)},e.assets.Character.prototype.setTextbox=function(e){this.asset.setAttribute("textbox",e.getAttribute("textbox")),this.bus.trigger("wse.assets.character.settextbox",this)},e.assets.Character.prototype.save=function(){var e={assetType:"Character",textboxName:this.asset.getAttribute("textbox")};return this.bus.trigger("wse.assets.character.save",{subject:this,saves:e}),e},e.assets.Character.prototype.restore=function(e){this.asset.setAttribute("textbox",e.textboxName),this.bus.trigger("wse.assets.character.restore",{subject:this,saves:e})}}(WSE),function(e){"use strict";e.assets.Curtain=function(t,s){this.asset=t,this.interpreter=s,this.bus=s.bus,this.stage=s.stage,this.color=t.getAttribute("color")||"black",this.z=t.getAttribute("z")||2e4,this.id=e.tools.getUniqueId(),this.cssid="WSECurtain_"+this.id,this.element=document.createElement("div"),this.name=t.getAttribute("name"),this.element.setAttribute("id",this.cssid),this.element.setAttribute("class","WSECurtain"),this.element.style.position="absolute",this.element.style.left=0,this.element.style.top=0,this.element.style.width=this.stage.offsetWidth+"px",this.element.style.height=this.stage.offsetHeight+"px",this.element.style.opacity=0,this.element.style.backgroundColor=this.color,this.element.style.zIndex=this.z,e.tools.applyAssetUnits(this,t),this.stage.appendChild(this.element)},e.assets.Curtain.prototype.set=function(e){this.color=e.getAttribute("color")||"black",this.element.style.backgroundColor=this.color},e.tools.mixin(e.assets.mixins.displayable,e.assets.Curtain.prototype),e.assets.Curtain.prototype.save=function(){return{color:this.color,cssid:this.cssid,z:this.z}},e.assets.Curtain.prototype.restore=function(e){this.color=e.color,this.cssid=e.cssid,this.z=e.z;try{this.element=document.getElementById(this.cssid)}catch(t){return void this.bus.trigger("wse.interpreter.warning",{message:"Element with CSS ID '"+this.cssid+"' could not be found."})}this.element.style.backgroundColor=this.color,this.element.style.zIndex=this.z}}(WSE),function(e){"use strict";e.assets.Imagepack=function(t,s){var i,n,r,a,o,u,c,h,l,d,g,m,p,f,b,y,v;for(this.stage=s.stage,this.bus=s.bus,this.name=t.getAttribute("name"),this.id=e.tools.getUniqueId(),this.cssid=t.getAttribute("cssid")||"wse_imagepack_"+this.name,this.interpreter=s,this.xAnchor=t.getAttribute("xAnchor"),this.yAnchor=t.getAttribute("yAnchor"),this.width=parseInt(t.getAttribute("width"),10)||100,this.height=parseInt(t.getAttribute("height"),10)||100,e.tools.applyAssetUnits(this,t),d=this,n={},i=document.createElement("div"),m=t.getAttribute("width"),p=t.getAttribute("height"),i.style.opacity=0,i.draggable=!1,i.setAttribute("class","imagepack"),i.setAttribute("id",this.cssid),i.setAttribute("data-wse-asset-name",this.name),r=t.getElementsByTagName("image"),g=function(){d.bus.trigger("wse.assets.loading.decrease")},a=0,o=r.length;o>a;a+=1)u=r[a],c=u.getAttribute("name"),h=u.getAttribute("src"),null!==c?null!==h?(l=new Image,this.bus.trigger("wse.assets.loading.increase"),e.tools.attachEventListener(l,"load",g),l.src=h,l.style.opacity=0,l.style.position="absolute",l.draggable=!1,l.setAttribute("data-wse-asset-image-name",c),null!==m&&l.setAttribute("width",m),null!==p&&l.setAttribute("height",p),n[c]=this.cssid+"_"+c,l.setAttribute("id",n[c]),i.appendChild(l)):this.bus.trigger("wse.interpreter.warning",{element:t,message:"Image without src in imagepack '"+this.name+"'."}):this.bus.trigger("wse.interpreter.warning",{element:t,message:"Image without name in imagepack '"+this.name+"'."});i.style.position="absolute",i.style.zIndex=t.getAttribute("z")||0,this.stage.appendChild(i),f=parseInt(t.getAttribute("x")||0,10),b=parseInt(t.getAttribute("y")||0,10),y=e.tools.extractUnit(t.getAttribute("x"))||"px",v=e.tools.extractUnit(t.getAttribute("y"))||"px","%"===y&&(f=this.stage.offsetWidth/100*f),"%"===v&&(b=this.stage.offsetHeight/100*b),f=e.tools.calculateValueWithAnchor(f,this.xAnchor,this.width),b=e.tools.calculateValueWithAnchor(b,this.yAnchor,this.height),"%"===y&&(f/=this.stage.offsetWidth/100),"%"===v&&(b/=this.stage.offsetHeight/100),i.style.left=""+f+y,i.style.top=""+b+v,this.images=n,this.current=null,this.bus.trigger("wse.assets.imagepack.constructor",this)},e.tools.mixin(e.assets.mixins.displayable,e.assets.Imagepack.prototype),e.assets.Imagepack.prototype.set=function(t,s){var i,n,r,a,o,u,c,h=this.bus;if(s=s||{},r=this,n=t.getAttribute("image"),o=t.getAttribute("duration")||400,u=s.animation===!0?!0:!1,null===n)return h.trigger("wse.interpreter.warning",{element:t,message:"Missing attribute 'image' on 'do' element referencing imagepack '"+this.name+"'."}),{doNext:!0};try{i=document.getElementById(this.images[n])}catch(l){console.error("DOM Element for Image "+n+" on Imagepack "+this.name+" not found!",l)}if("undefined"==typeof i||null===i)return h.trigger("wse.interpreter.warning",{element:t,message:"Unknown image name on 'do' element referencing imagepack '"+this.name+"'."}),{doNext:!0};a=this.current;for(var d in this.images)if(this.images.hasOwnProperty(d)){if(d!==n)continue;if(d===a)return h.trigger("wse.interpreter.warning",{element:t,message:"Trying to set the image that is already set on imagepack '"+this.name+"'."}),{doNext:!0}}return u||(r.interpreter.waitCounter+=1),c=document.getElementById(this.cssid),c.style.width=i.offsetWidth+"px",c.style.height=i.offsetHeight+"px",function(){var t,s,n;t=function(e){i.style.opacity=e},s=function(){u||(r.interpreter.waitCounter-=1)},n={duration:o,easing:e.fx.easing.easeOutCubic,onFinish:s},e.fx.transform(t,0,1,n)}(),null!==this.current&&(u||(r.interpreter.waitCounter+=1),function(){var t;(t=function(){var t,s,i,n;t=document.getElementById(r.images[a]),s=function(e){t.style.opacity=e},i=function(){u||(r.interpreter.waitCounter-=1)},n={duration:o,easing:e.fx.easing.easeInCubic,onFinish:i},e.fx.transform(s,1,0,n)})()}()),this.current=n,{doNext:!0}},e.assets.Imagepack.prototype.save=function(){var e,t,s,i,n;s=this.images,e=this.current||null,i=null;for(t in s)s.hasOwnProperty(t)&&s[t]===e&&(i=t);return n={assetType:"Imagepack",current:e,cssid:this.cssid,images:s,xAnchor:this.xAnchor,yAnchor:this.yAnchor,z:this.z},this.bus.trigger("wse.assets.imagepack.save",{subject:this,saves:n}),n},e.assets.Imagepack.prototype.restore=function(e){var t;t=e.current,this.cssid=e.cssid,this.z=e.z,this.current=t,this.xAnchor=e.xAnchor,this.yAnchor=e.yAnchor,document.getElementById(this.cssid).style.zIndex=this.z,this.bus.trigger("wse.assets.imagepack.restore",{subject:this,saves:e})}}(WSE),function(e){"use strict";e.assets.Textbox=function(t,s){if(!(this instanceof e.assets.Textbox))return new e.assets.Textbox(t,s);var i,n,r,a,o,u,c,h;this.interpreter=s,this.name=t.getAttribute("name"),this.stage=s.stage,this.bus=s.bus,this.type=t.getAttribute("behaviour")||"adv",this.z=t.getAttribute("z")||5e3,this.showNames="yes"===t.getAttribute("namebox")?!0:!1,this.nltobr="true"===t.getAttribute("nltobr")?!0:!1,this.id=e.tools.getUniqueId(),this.cssid="wse_textbox_"+this.name,this.effectType=t.getAttribute("effect")||"typewriter",this.speed=t.getAttribute("speed")||0,this.speed=parseInt(this.speed,10),this.fadeDuration=t.getAttribute("fadeDuration")||0,e.tools.applyAssetUnits(this,t),function(e){var s,i,n,r;try{for(r=t.childNodes,i=0,n=r.length;n>i;i+=1)if(1===r[i].nodeType&&"nameTemplate"===r[i].tagName){s=r[i];break}if(!s)throw new Error("No nameTemplate found.");e.nameTemplate=(new XMLSerializer).serializeToString(s)}catch(a){e.nameTemplate="{name}: "}}(this),"nvl"===this.type&&(this.showNames=!1),i=document.createElement("div"),n=document.createElement("div"),r=document.createElement("div"),i.setAttribute("class","textbox"),r.setAttribute("class","text"),n.setAttribute("class","name"),a=t.getAttribute("cssid")||this.cssid,i.setAttribute("id",a),this.cssid=a,o=t.getAttribute("x"),o&&(i.style.left=o),u=t.getAttribute("y"),u&&(i.style.top=u),i.style.zIndex=this.z,c=t.getAttribute("width"),h=t.getAttribute("height"),c&&(i.style.width=c),h&&(i.style.height=h),i.appendChild(n),i.appendChild(r),this.stage.appendChild(i),this.showNames===!1&&(n.style.display="none"),n.setAttribute("id",this.cssid+"_name"),r.setAttribute("id",this.cssid+"_text"),this.nameElement=this.cssid+"_name",this.textElement=this.cssid+"_text",i.style.opacity=0,this.bus.trigger("wse.assets.textbox.constructor",this)},e.tools.mixin(e.assets.mixins.displayable,e.assets.Textbox.prototype),e.assets.Textbox.prototype.put=function(t,s){function i(){"adv"===o.type&&(n.innerHTML=""),n.innerHTML+=a+t,r.innerHTML=o.nameTemplate.replace(/\{name\}/g,s)}var n,r,a,o;return s=s||null,o=this,n=document.getElementById(this.textElement),r=document.getElementById(this.nameElement),t=e.tools.replaceVariables(t,this.interpreter),o.interpreter.waitCounter+=1,a="",this.showNames===!1&&s&&(a=this.nameTemplate.replace(/\{name\}/g,s)),null===s&&(s=""),this.speed<1&&(this.fadeDuration>0?(o.interpreter.waitCounter+=1,function(){var t,s,i;t=function(e){n.style.opacity=e},s=function(){o.interpreter.waitCounter-=1},i={duration:o.fadeDuration,onFinish:s},e.fx.transform(t,1,0,i)}()):i()),this.speed>0?("adv"===o.type&&(n.innerHTML=""),function(){var i;i=document.createElement("div"),i.setAttribute("class","line"),n.appendChild(i),i.innerHTML=a+t,r.innerHTML=o.nameTemplate.replace(/\{name\}/g,s),o.interpreter.waitCounter+=1,e.fx.dom.effects.typewriter(i,{speed:o.speed,onFinish:function(){o.interpreter.waitCounter-=1}})}()):this.fadeDuration>0&&(o.interpreter.waitCounter+=1,setTimeout(function(){i(),"nvl"===o.type&&(n.innerHTML="<div>"+n.innerHTML+"</div>"),e.fx.transform(function(e){n.style.opacity=e},0,1,{duration:o.fadeDuration,onFinish:function(){o.interpreter.waitCounter-=1}})},o.fadeDuration)),this.bus.trigger("wse.assets.textbox.put",this,!1),o.interpreter.waitCounter-=1,{doNext:!1}},e.assets.Textbox.prototype.clear=function(){return document.getElementById(this.textElement).innerHTML="",document.getElementById(this.nameElement).innerHTML="",this.bus.trigger("wse.assets.textbox.clear",this),{doNext:!0}},e.assets.Textbox.prototype.save=function(){return{assetType:"Textbox",type:this.type,showNames:this.showNames,nltobr:this.nltobr,cssid:this.cssid,nameElement:this.nameElement,textElement:this.textElement,z:this.z}},e.assets.Textbox.prototype.restore=function(e){this.type=e.type,this.showNames=e.showNames,this.nltobr=e.nltobr,this.cssid=e.cssid,this.nameElement=e.nameElement,this.textElement=e.textElement,this.z=e.z,document.getElementById(this.cssid).style.zIndex=this.z}}(WSE),function(e){"use strict";function t(e){e.element.setAttribute("width",e.stage.offsetWidth),e.element.setAttribute("height",e.stage.offsetHeight)}function s(e){var t=e.element.style;e.element.setAttribute("id",e.cssid),e.element.setAttribute("class","WSEBackground"),e.element.style.position="absolute",e.element.draggable=!1,t.left=0,t.top=0,t.opacity=0,t.zIndex=e.z}e.assets.Background=function(i,n){var r=this;return this.asset=i,this.interpreter=n,this.bus=n.bus,this.stage=n.stage,this.z=i.getAttribute("z")||10,this.id=e.tools.getUniqueId(),this.cssid="WSEBackground_"+this.id,this.element=document.createElement("img"),this.src=i.getAttribute("src"),this.name=i.getAttribute("name"),this.src?(e.tools.applyAssetUnits(this,i),this.element.setAttribute("src",this.src),s(this),t(this),window.addEventListener("resize",function(){t(r)}),void this.stage.appendChild(this.element)):void this.bus.trigger("wse.interpreter.warning",{element:i,message:"No source defined on background asset."})},e.tools.mixin(e.assets.mixins.displayable,e.assets.Background.prototype),e.assets.Background.prototype.save=function(){return{cssid:this.cssid,z:this.z}},e.assets.Background.prototype.restore=function(e){this.cssid=e.cssid,this.z=e.z;try{this.element=document.getElementById(this.cssid)}catch(t){return void this.bus.trigger("wse.interpreter.warning",{message:"Element with CSS ID '"+this.cssid+"' could not be found."})}}}(WSE),function(e){"use strict";e.commands["break"]=function(e,t){return t.bus.trigger("wse.interpreter.commands.break",{interpreter:t,command:e},!1),{doNext:!1,wait:!0}}}(WSE),function(e){"use strict";e.commands.choice=function(t,s){var i,n,r,a,o,u,c,h,l,d,g,m,p,f;for(s.bus.trigger("wse.interpreter.commands.choice",{interpreter:s,command:t},!1),p=s.state,s.state="pause",n=[],l=[],d=s,r=t.childNodes,a=r.length,c=t.getAttribute("duration")||500,c=parseInt(c,10),f=t.getAttribute("cssid")||"WSEChoiceMenu",m=function(e,t,i,n){return i=i||null,function(r){r.stopPropagation(),r.preventDefault(),setTimeout(function(){var t=e.children.length,r=s.index,a=s.sceneId,o=s.scenePath.slice(),u=s.currentScene;null!==i&&d.changeSceneNoNext(i),t>0&&(s.pushToCallStack(),s.currentCommands=e.childNodes,s.sceneId=a,s.scenePath=o,s.scenePath.push(r-1),s.scenePath.push(n),s.index=0,s.currentScene=u,s.currentElement=0),d.next()},0),d.stage.removeChild(t),s.waitCounter-=1,s.state=p}},1>a&&s.bus.trigger("wse.interpreter.warning",{element:t,message:"Element 'choice' is empty. Expected at least one 'option' element."}),i=document.createElement("div"),i.setAttribute("class","menu"),i.setAttribute("id",f),i.setAttribute("data-wse-index",s.index),i.setAttribute("data-wse-scene-id",s.sceneId),i.setAttribute("data-wse-game",s.game.url),i.setAttribute("data-wse-type","choice"),o=0;a>o;o+=1)u=r[o],u.tagName&&"option"===u.tagName&&s.checkIfvar(u)&&(h=document.createElement("input"),h.setAttribute("class","button"),h.setAttribute("type","button"),h.setAttribute("tabindex",o+1),h.setAttribute("value",u.getAttribute("label")),h.value=e.tools.replaceVariables(u.getAttribute("label"),s),g=u.getAttribute("scene")||null,l[o]=g?s.getSceneById(g):null,e.tools.attachEventListener(h,"click",m(u,i,l[o],o)),n.push(h),i.appendChild(h));return i.style.opacity=0,s.stage.appendChild(i),e.assets.mixins.displayable.show(t,{element:i,bus:s.bus,stage:s.stage,interpreter:s}),s.waitCounter+=1,{doNext:!1,wait:!0}}}(WSE),function(e){"use strict";e.commands["do"]=function(e,t,s){var i,n,r,a=t.bus,o=t.assets;return s=s||{},a.trigger("wse.interpreter.commands.do",{interpreter:t,command:e},!1),i=e.getAttribute("asset"),n=e.getAttribute("action"),r=s.animation||!1,null===i?void a.trigger("wse.interpreter.warning",{element:e,message:"Element of type 'do' must have an attribute 'asset'. Element ignored."}):null===n?void a.trigger("wse.interpreter.warning",{element:e,message:"Element of type 'do' must have an attribute 'action'. Element ignored."}):"undefined"==typeof o[i]||null===o[i]?(a.trigger("wse.interpreter.warning",{element:e,message:"Reference to unknown asset '"+i+"'."}),{doNext:!0}):"undefined"==typeof o[i][n]?(a.trigger("wse.interpreter.warning",{element:e,message:"Action '"+n+"' is not defined for asset '"+i+"'."}),{doNext:!0}):o[i][n](e,s)}}(WSE),function(e){"use strict";e.commands.fn=function(t,s){var i,n,r;return i=t.getAttribute("name")||null,n=t.getAttribute("tovar")||null,"function"!=typeof e.functions[i]?(s.bus.trigger("wse.interpreter.warning",{element:t,message:"No name supplied on fn element."}),{doNext:!0}):"function"!=typeof e.functions[i]?(s.bus.trigger("wse.interpreter.warning",{element:t,message:"Unknown function '"+i+"'."}),{doNext:!0}):(r=e.functions[i](s),null!==n&&(s.runVars[n]=""+r),{doNext:!0})}}(WSE),function(e){"use strict";e.commands.global=function(e,t){var s,i;return s=e.getAttribute("name")||null,i=e.getAttribute("value")||null,null===s?(t.bus.trigger("wse.interpreter.warning",{element:e,message:"No name defined on element 'global'."}),{doNext:!0}):null===i?(t.bus.trigger("wse.interpreter.warning",{element:e,message:"No value defined on element 'global'."}),{doNext:!0}):(t.globalVars.set(s,i),{doNext:!0})}}(WSE),function(e){"use strict";e.commands.globalize=function(e,t){var s;return s=e.getAttribute("name")||null,null===s?(t.bus.trigger("wse.interpreter.warning",{element:e,message:"No variable name defined on globalize element."}),{doNext:!0}):"undefined"==typeof t.runVars[s]||null===t.runVars[s]?(t.bus.trigger("wse.interpreter.warning",{element:e,message:"Undefined local variable."}),{doNext:!0}):(t.globalVars.set(s,t.runVars[s]),{doNext:!0})}}(WSE),function(e){"use strict";e.commands.goto=function(t,s){var i,n,r=s.bus;return r.trigger("wse.interpreter.commands.goto",{interpreter:s,command:t},!1),n=t.getAttribute("scene"),null===n&&r.trigger("wse.interpreter.error",{message:"Element 'goto' misses attribute 'scene'."}),n=e.tools.replaceVariables(n,s),i=s.getSceneById(n),null===i?void r.trigger("wse.interpreter.error",{message:"Unknown scene '"+n+"'."}):{changeScene:i}}}(WSE),function(e){"use strict";e.commands.line=function(t,s){var i,n,r,a,o,u,c,h,l,d=s.bus;if(d.trigger("wse.interpreter.commands.line",{interpreter:s,command:t},!1),i=t.getAttribute("s"),l="false"===t.getAttribute("stop")?!0:!1,null===i)return d.trigger("wse.interpreter.warning",{element:t,message:"Element 'line' requires attribute 's'."}),{doNext:!0};for(c=s.story.getElementsByTagName("character"),o=c.length,a=0;o>a;a+=1)if(u=c[a],u.getAttribute("name")===i){if(r=u.getAttribute("textbox"),"undefined"==typeof r||null===r)return d.trigger("wse.interpreter.warning",{element:t,message:"No textbox defined for character '"+i+"'."}),{doNext:!0};try{n=e.tools.getSerializedNodes(u.getElementsByTagName("displayname")[0])}catch(g){}break}return"undefined"==typeof s.assets[r]?(d.trigger("wse.interpreter.warning",{element:t,message:"Trying to use an unknown textbox or character."}),{doNext:!0}):(h=e.tools.getSerializedNodes(t),s.log.push({speaker:i,text:h}),s.assets[r].put(h,n),{doNext:l,wait:!0})}}(WSE),function(e){"use strict";e.commands.localize=function(e,t){var s;return s=e.getAttribute("name")||null,null===s?(t.bus.trigger("wse.interpreter.warning",{element:e,message:"No variable name defined on localize element."}),{doNext:!0}):t.globalVars.has(s)?(t.runVars[s]=t.globalVars.get(s),{doNext:!0}):(t.bus.trigger("wse.interpreter.warning",{element:e,message:"Undefined global variable."}),{doNext:!0})
}}(WSE),function(e){"use strict";e.commands.restart=function(e,t){for(t.bus.trigger("wse.interpreter.commands.restart",{interpreter:t,command:e},!1),t.bus.trigger("wse.interpreter.message","Restarting game...",!1),t.bus.trigger("wse.interpreter.restart",t,!1),t.runVars={},t.log=[],t.visitedScenes=[],t.startTime=Math.round(+new Date/1e3),t.waitCounter=0,t.state="listen",t.stage.innerHTML="",t.assets={},t.buildAssets();t.callStack.length>0;)t.callStack.shift();return{doNext:!0,changeScene:t.getFirstScene()}}}(WSE),function(e){"use strict";e.commands.sub=function(t,s){var i,n,r;return s.bus.trigger("wse.interpreter.commands.sub",{interpreter:s,command:t},!1),i=t.getAttribute("scene")||null,r=t.getAttribute("next")===!1?!1:!0,null===i?(s.bus.trigger("wse.interpreter.warning",{element:t,message:"Missing 'scene' attribute on 'sub' command!"}),{doNext:!0}):(i=e.tools.replaceVariables(i,s),(n=s.getSceneById(i))?(s.bus.trigger("wse.interpreter.message","Entering sub scene '"+i+"'...",!1),s.pushToCallStack(),s.currentCommands=n.childNodes,s.index=-1,s.sceneId=i,s.scenePath=[],s.currentElement=-1,t.getAttribute("names")&&e.commands.set_vars(t,s),{doNext:r}):(s.bus.trigger("wse.interpreter.error",{message:"No such scene '"+i+"'!",command:t}),{doNext:!0}))}}(WSE),function(e){"use strict";e.commands.trigger=function(e,t){var s,i;return t.bus.trigger("wse.interpreter.commands.trigger",{interpreter:t,command:e},!1),s=e.getAttribute("name")||null,i=e.getAttribute("action")||null,null===s?(t.bus.trigger("wse.interpreter.warning",{element:e,message:"No name specified on trigger command."}),{doNext:!0}):null===i?(t.bus.trigger("wse.interpreter.warning",{element:e,message:"No action specified on trigger command referencing trigger '"+s+"'."}),{doNext:!0}):"undefined"==typeof t.triggers[s]||null===t.triggers[s]?(t.bus.trigger("wse.interpreter.warning",{element:e,message:"Reference to unknown trigger '"+s+"'."}),{doNext:!0}):"function"!=typeof t.triggers[s][i]?(t.bus.trigger("wse.interpreter.warning",{element:e,message:"Unknown action '"+i+"' on trigger command referencing trigger '"+s+"'."}),{doNext:!0}):(t.triggers[s][i](e),{doNext:!0})}}(WSE),function(e){"use strict";e.commands["var"]=function(t,s){var i,n,r,a,o;if(s.bus.trigger("wse.interpreter.commands.var",{interpreter:s,command:t},!1),i=t.getAttribute("name")||null,n=t.getAttribute("value")||"1",a=t.getAttribute("action")||"set",null===i)return s.bus.trigger("wse.interpreter.warning",{element:t,message:"Command 'var' must have a 'name' attribute."}),{doNext:!0};if(o=s.runVars,"set"!==a&&!(i in o||t.getAttribute("lvalue")))return s.bus.trigger("wse.interpreter.warning",{element:t,message:"Undefined variable."}),{doNext:!0};if(n=e.tools.replaceVariables(n,s),"set"===a)return o[i]=""+n,{doNext:!0};switch(r=t.getAttribute("lvalue")||o[i],r=e.tools.replaceVariables(r,s),a){case"delete":delete o[i];break;case"increase":o[i]=""+(parseFloat(r)+parseFloat(n));break;case"decrease":o[i]=""+(parseFloat(r)-parseFloat(n));break;case"multiply":o[i]=""+parseFloat(r)*parseFloat(n);break;case"divide":o[i]=""+parseFloat(r)/parseFloat(n);break;case"modulus":o[i]=""+parseFloat(r)%parseFloat(n);break;case"and":o[i]=""+(parseFloat(r)&&parseFloat(n));break;case"or":o[i]=""+(parseFloat(r)||parseFloat(n));break;case"not":o[i]=parseFloat(r)?"0":"1";break;case"is_greater":o[i]=parseFloat(r)>parseFloat(n)?"1":"0";break;case"is_less":o[i]=parseFloat(r)<parseFloat(n)?"1":"0";break;case"is_equal":o[i]=parseFloat(r)===parseFloat(n)?"1":"0";break;case"not_greater":o[i]=parseFloat(r)<=parseFloat(n)?"1":"0";break;case"not_less":o[i]=parseFloat(r)>=parseFloat(n)?"1":"0";break;case"not_equal":o[i]=parseFloat(r)!==parseFloat(n)?"1":"0";break;case"print":s.bus.trigger("wse.interpreter.message","Variable '"+i+"' is: "+o[i]);break;default:s.bus.trigger("wse.interpreter.warning",{element:t,message:"Unknown action '"+a+"' defined on 'var' command."})}return{doNext:!0}}}(WSE),function(e){"use strict";e.commands.set_vars=function(e,t){var s,i,n=t.runVars;return s=(e.getAttribute("names")||"").split(","),i=(e.getAttribute("values")||"").split(","),s.length!==i.length?(t.bus.trigger("wse.interpreter.error",{message:"Number of names does not match number of values in <set_vars> command."}),{doNext:!0}):(s.forEach(function(e,t){n[e.trim()]=""+i[t].trim()}),{doNext:!0})}}(WSE),function(e){"use strict";e.commands.wait=function(e,t){var s,i;return t.bus.trigger("wse.interpreter.commands.wait",{interpreter:t,command:e},!1),i=t,s=e.getAttribute("duration"),null!==s?(s=parseInt(s,10),t.waitForTimer=!0,setTimeout(function(){i.waitForTimer=!1},s),{doNext:!0,wait:!1}):{doNext:!0,wait:!0}}}(WSE),function(e){"use strict";e.commands["with"]=function(t,s){var i,n,r=s.runVars,a=t.childNodes,o=e.tools.getParsedAttribute(t,"var",s),u=a.length;for(i=0;u>i;i+=1)if(n=a[i],n.tagName&&s.checkIfvar(n)&&("when"===n.tagName||"else"===n.tagName)&&("when"!==n.tagName||n.hasAttribute("is")||s.bus.trigger("wse.interpreter.warning",{message:"Element 'when' without a condition. Ignored.",command:t}),"else"===n.tagName&&n.hasAttribute("is")&&s.bus.trigger("wse.interpreter.warning",{message:"Element 'else' with a condition. Ignored.",command:t}),"else"===n.tagName||"when"===n.tagName&&n.hasAttribute("is")&&e.tools.getParsedAttribute(n,"is")===r[o])){s.pushToCallStack(),s.currentCommands=n.childNodes,s.scenePath.push(s.index),s.scenePath.push(i),s.index=-1,s.currentElement=-1;break}return{doNext:!0}}}(WSE),function(e){"use strict";e.commands.while=function(e,t){return t.index-=1,t.currentElement-=1,t.pushToCallStack(),t.currentCommands=e.childNodes,t.scenePath.push(t.index+1),t.index=-1,t.currentElement=-1,{doNext:!0}}}(WSE);